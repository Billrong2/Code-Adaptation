{
  "code": "@Override\npublic boolean onTouchEvent(MotionEvent event) {\n    // Only handle touch when text is truly Spannable (required for Selection operations)\n    CharSequence text = getText();\n    if (!(text instanceof Spannable)) {\n        return false;\n    }\n\n    Layout layout = getLayout();\n    if (layout == null) {\n        return false;\n    }\n\n    final int action = event.getAction();\n    if (action != MotionEvent.ACTION_DOWN && action != MotionEvent.ACTION_UP) {\n        return false;\n    }\n\n    // Translate touch coordinates into text layout coordinates\n    int x = (int) event.getX();\n    int y = (int) event.getY();\n\n    x -= getTotalPaddingLeft();\n    y -= getTotalPaddingTop();\n    x += getScrollX();\n    y += getScrollY();\n\n    // Ensure y maps to a valid line\n    int lineCount = layout.getLineCount();\n    if (lineCount == 0) {\n        return false;\n    }\n\n    int line = layout.getLineForVertical(y);\n    if (line < 0 || line >= lineCount) {\n        return false;\n    }\n\n    int offset = layout.getOffsetForHorizontal(line, x);\n    Spannable buffer = (Spannable) text;\n\n    ClickableSpan[] links = buffer.getSpans(offset, offset, ClickableSpan.class);\n    if (links == null || links.length == 0) {\n        return false;\n    }\n\n    ClickableSpan link = links[0];\n\n    if (action == MotionEvent.ACTION_DOWN) {\n        // Highlight/select on DOWN and consume the event\n        Selection.setSelection(buffer,\n                buffer.getSpanStart(link),\n                buffer.getSpanEnd(link));\n        return true;\n    } else if (action == MotionEvent.ACTION_UP) {\n        // Invoke click on UP but do NOT consume, allowing parent handlers to receive it\n        link.onClick(this);\n        return false;\n    }\n\n    return false;\n}",
  "explanation": "code_hardening: Added null checks for getLayout(), verified line count and line bounds, and ensured the text is an instance of Spannable (not just Spanned) before casting and using Selection.\nresolve_compilation_errors: Implemented onTouchEvent directly in LinkTextView (which extends TextView), corrected @Override usage, and relied on existing Android framework types already present in the file.\nexception_handling: none.\nlogic_customization: Changed event flow to select/highlight spans on ACTION_DOWN while consuming the event, and to invoke ClickableSpan.onClick on ACTION_UP without consuming it; removed unconditional handling so non-consumed paths return false.\nrefactoring: Improved local variable naming (text, buffer, links, lineCount, offset) and structured the method into clear logical sections without introducing additional helper methods.\nmisc: Updated inline comments to document the new touch-consumption behavior and kept formatting consistent with standard Android style; no new custom API calls were introduced."
}