{
  "code": "public static int calculateInSampleSize(final android.graphics.BitmapFactory.Options options, final int reqWidth, final int reqHeight) {\n    // Defensive defaults\n    if (options == null) {\n        return 1;\n    }\n\n    final int originalWidth = options.outWidth;\n    final int originalHeight = options.outHeight;\n\n    // Validate decoded bounds\n    if (originalWidth <= 0 || originalHeight <= 0) {\n        return 1;\n    }\n\n    // Guard against invalid requested sizes to avoid division by zero\n    if (reqWidth <= 0 || reqHeight <= 0) {\n        return 1;\n    }\n\n    // If no downscaling is needed, keep original behavior\n    if (originalWidth <= reqWidth && originalHeight <= reqHeight) {\n        return 1;\n    }\n\n    // Direct ratio-based calculation (allows non–power-of-two values)\n    final float widthRatioFloat = (float) originalWidth / (float) reqWidth;\n    final float heightRatioFloat = (float) originalHeight / (float) reqHeight;\n\n    // Round to nearest integer ratios\n    final int widthRatio = Math.max(1, Math.round(widthRatioFloat));\n    final int heightRatio = Math.max(1, Math.round(heightRatioFloat));\n\n    // Use the smaller ratio to ensure both dimensions meet or exceed requested size\n    final int inSampleSize = Math.min(widthRatio, heightRatio);\n\n    return inSampleSize > 0 ? inSampleSize : 1;\n}",
  "explanation": "code_hardening: Added null checks for options, validated decoded bounds (outWidth/outHeight > 0), guarded against zero or negative requested dimensions to prevent division by zero, and ensured the returned inSampleSize is always at least 1. Marked parameters and key locals as final.\nresolve_compilation_errors: Preserved the existing static method signature used by doInBackground and referenced BitmapFactory.Options with its fully qualified name in the signature to avoid import ambiguity. No new imports were required.\nexception_handling: none.\nlogic_customization: Replaced the power-of-two iterative halving logic with a direct ratio-based calculation. Computed width and height ratios by dividing original dimensions by requested dimensions, rounded them to the nearest integer, selected the smaller ratio as inSampleSize, allowed non–power-of-two values, and preserved returning 1 when no downscaling is required.\nrefactoring: Renamed locals for clarity (originalWidth/originalHeight), removed unused half-dimension variables and looping logic, and simplified control flow for readability.\nmisc: Updated inline comments to reflect the new ratio-based scaling approach and kept formatting consistent with the surrounding utility methods. New custom API calls used: none."
}