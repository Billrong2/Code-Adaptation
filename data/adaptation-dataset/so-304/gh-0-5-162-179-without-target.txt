package org.jdownloader.captcha.utils;

import java.awt.Graphics2D;
import java.awt.color.ColorSpace;
import java.awt.image.BufferedImage;
import java.awt.image.ColorConvertOp;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.InputStream;

import javax.imageio.ImageIO;

import jd.utils.EditDistance;


public class ImagePHash {

    private int size        = 32;
    private int smallerSize = 8;

    public ImagePHash() {
        initCoefficients();
    }

    public static void main(String[] args) throws FileNotFoundException, Exception {

        File a = new File("C:\\Users\\Thomas\\.appwork\\captchas\\2ff9d0edd827a1549010efb2a9f6cc6c.png.left.0011011011010011110110110000010100100001101000001.png");
        File b = new File("C:\\Users\\Thomas\\.appwork\\captchas\\0c65196051b97fabe6e1abe8349c7a3a.png.left.0011011111110111010011110001011000100011100000100.png");
        ImagePHash hasher = new ImagePHash(32, 8);
        String ah;
        System.out.println(ah = new ImagePHash(32, 8).getHash(new FileInputStream(a)));
        String bh;
        System.out.println(bh = hasher.getHash(new FileInputStream(b)));
        System.out.println(hasher.distance(ah, bh));
        System.out.println("LEv " + EditDistance.getLevenshteinDifference(ah, bh) + " - " + EditDistance.getLevenshteinDistance(ah, bh));
    }

    public ImagePHash(int size, int smallerSize) {
        this.size = size;
        this.smallerSize = smallerSize;

        initCoefficients();
    }

    public int distance(String s1, String s2) {
        int counter = 0;
        for (int k = 0; k < s1.length(); k++) {
            if (s1.charAt(k) != s2.charAt(k)) {
                counter++;
            }
        }
        return counter;
    }

    
    public String getHash(InputStream is) throws Exception {
        BufferedImage img = ImageIO.read(is);

        
        img = resize(img, size, size);

        
        img = grayscale(img);

        double[][] vals = new double[size][size];

        for (int x = 0; x < img.getWidth(); x++) {
            for (int y = 0; y < img.getHeight(); y++) {
                vals[x][y] = getBlue(img, x, y);
            }
        }

        
        long start = System.currentTimeMillis();
        double[][] dctVals = applyDCT(vals);
        System.out.println("DCT: " + (System.currentTimeMillis() - start));

        
        
        double total = 0;

        for (int x = 0; x < smallerSize; x++) {
            for (int y = 0; y < smallerSize; y++) {
                total += dctVals[x][y];
            }
        }
        total -= dctVals[0][0];

        double avg = total / ((smallerSize * smallerSize) - 1);

        
        String hash = "";

        for (int x = 0; x < smallerSize; x++) {
            for (int y = 0; y < smallerSize; y++) {
                if (x != 0 && y != 0) {
                    hash += (dctVals[x][y] > avg ? "1" : "0");
                }
            }
        }

        return hash;
    }

    private BufferedImage resize(BufferedImage image, int width, int height) {
        BufferedImage resizedImage = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);
        Graphics2D g = resizedImage.createGraphics();
        g.drawImage(image, 0, 0, width, height, null);
        g.dispose();
        return resizedImage;
    }

    private ColorConvertOp colorConvert = new ColorConvertOp(ColorSpace.getInstance(ColorSpace.CS_GRAY), null);

    private BufferedImage grayscale(BufferedImage img) {
        colorConvert.filter(img, img);
        return img;
    }

    private static int getBlue(BufferedImage img, int x, int y) {
        return (img.getRGB(x, y)) & 0xff;
    }

    

    private double[] c;

    private void initCoefficients() {
        c = new double[size];

        for (int i = 1; i < size; i++) {
            c[i] = 1;
        }
        c[0] = 1 / Math.sqrt(2.0);
    }

    // TODO


}