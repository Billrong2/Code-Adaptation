package ca.ubc.ctlt.group.consumer;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import com.xythos.common.api.XythosException;

import au.com.bytecode.opencsv.CSVWriter;
import blackboard.cms.filesystem.CSContext;
import blackboard.cms.filesystem.CSFileSystemException;
import ca.ubc.ctlt.group.Consumer;
import ca.ubc.ctlt.group.GroUser;
import ca.ubc.ctlt.group.GroGroup;
import ca.ubc.ctlt.group.GroupSet;

public class CsvConsumer extends Consumer {
	
	private char[] oldChars = new char[10];

	@Override
	public void setGroupSets(Map<String, GroupSet> sets) throws Exception {
		if (sets.isEmpty()) {
			log("No group to save!");
			return;
		}

		
		List<String[]> data = new ArrayList<String[]>();
		String[] header = { "Group", "Name", "Username", "Student ID", "GroupSet" };
		data.add(header);

		for (Entry<String, GroupSet> entryGroupSet : sets.entrySet()) {
			GroupSet set = entryGroupSet.getValue();
			String setName = set.getName().equals(GroupSet.EMPTY_NAME) ? ""
					: set.getName();

			for (Entry<String, GroGroup> entryGroup : set.getGroups().entrySet()) {
				GroGroup group = entryGroup.getValue();

				for (Entry<String, GroUser> entryMember : group.getMemberList()
						.entrySet()) {
					GroUser user = entryMember.getValue();
					String[] row = { group.getName(), user.getName(), user.getUserName(),
							user.getStudentID(), setName };
					data.add(row);
				}
			}
		}

		
		
		String op = request.getParameter("csvExportOperation");
		if (op.equals("download")) {
			downloadCSV(data);
		} else {
			saveToCS(data);
		}
	}

	
	private void saveToCS(List<String[]> data) throws IOException {
		log("Saving to Content Collection");
		
		
		
		
		ByteArrayOutputStream csvOutput = new ByteArrayOutputStream();
		OutputStreamWriter streamWriter = new OutputStreamWriter(csvOutput,
				"UTF-8");
		CSVWriter writer = new CSVWriter(streamWriter); 
														
														
		writer.writeAll(data);
		writer.close();
		ByteArrayInputStream input = new ByteArrayInputStream(
				csvOutput.toByteArray());

		try {
			String fileName = request.getParameter("csvExportName");
			String path = request.getParameter("csvExportCSFolder_CSFile");
			CSContext csCtx = CSContext.getContext();
			csCtx.createFile(path, fileName, input, true);
			csCtx.commit();
		} catch (CSFileSystemException e) {
			
			error("Couldn't create the file, did you select a directory?");
			error(e.getMessage());
		} catch (XythosException e)
		{ 
			error("Content system was unable to create the file.");
			error(e.getMessage());
		}
	}

	
	private void downloadCSV(List<String[]> data) throws IOException {
		log("Downloading Export");
		byte[] rawFileName = request.getParameter("csvExportName").getBytes();
		
		String fileName = new String(rawFileName, "ISO-8859-1");
		
		if (!fileName.endsWith(".csv")) {
			fileName += ".csv";
		}
		
		fileName = sanitizeFileName(fileName);

		OutputStreamWriter streamWriter = new OutputStreamWriter(
				response.getOutputStream(), "UTF-8");
		CSVWriter writer = new CSVWriter(streamWriter);

		response.setContentType("text/plain");
		
		
		
		
		
		
		response.addHeader("Content-Disposition", "attachment; filename=\""
				+ fileName + '"');
		// response.setContentLength();

		writer.writeAll(data);
		writer.close();
	}

	/**
	 * Strips unprintable characters and other special characters that might
	 * allow the user to manipulate the http header.
	 * 
	 * Code from:
	 * http://stackoverflow.com/questions/7161534/fastest-way-to-strip
	 * -all-non-printable-characters-from-a-java-string
	 * 
	 * @param s
	 * @return
	 * @throws Exception
	 */	// TODO


	@Override
	public String getOptionsPage() {
		return "consumers/csv/csvconsumers.jsp";
	}

	@Override
	public String getName() {
		return "CSV";
	}

	@Override
	public String getDescription() {
		return "Exports group information to a CSV file.";
	}

}
