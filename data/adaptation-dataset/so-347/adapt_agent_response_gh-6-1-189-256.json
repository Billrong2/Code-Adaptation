{
  "code": "int getScreenOrientation() {\n    final Context ctx = this.context;\n    if (ctx == null) {\n      Log.w(TAG, \"Context is null. Defaulting to portrait orientation.\");\n      return ActivityInfo.SCREEN_ORIENTATION_PORTRAIT;\n    }\n\n    Activity activity = null;\n    if (ctx instanceof Activity) {\n      activity = (Activity) ctx;\n    } else {\n      Log.w(TAG, \"Context is not an Activity. Defaulting to portrait orientation.\");\n      return ActivityInfo.SCREEN_ORIENTATION_PORTRAIT;\n    }\n\n    final WindowManager windowManager = activity.getWindowManager();\n    if (windowManager == null) {\n      Log.w(TAG, \"WindowManager is null. Defaulting to portrait orientation.\");\n      return ActivityInfo.SCREEN_ORIENTATION_PORTRAIT;\n    }\n\n    final Display display = windowManager.getDefaultDisplay();\n    if (display == null) {\n      Log.w(TAG, \"Display is null. Defaulting to portrait orientation.\");\n      return ActivityInfo.SCREEN_ORIENTATION_PORTRAIT;\n    }\n\n    final int rotation;\n    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.GINGERBREAD) {\n      rotation = display.getRotation();\n    } else {\n      // Deprecated on newer APIs but required for legacy compatibility\n      rotation = display.getOrientation();\n    }\n\n    final DisplayMetrics dm = new DisplayMetrics();\n    display.getMetrics(dm);\n    final int width = dm.widthPixels;\n    final int height = dm.heightPixels;\n\n    int orientation;\n    // if the device's natural orientation is portrait:\n    if (((rotation == Surface.ROTATION_0 || rotation == Surface.ROTATION_180) && height > width) ||\n        ((rotation == Surface.ROTATION_90 || rotation == Surface.ROTATION_270) && width > height)) {\n      switch (rotation) {\n        case Surface.ROTATION_0:\n          orientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT;\n          break;\n        case Surface.ROTATION_90:\n          orientation = ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE;\n          break;\n        case Surface.ROTATION_180:\n          orientation = ActivityInfo.SCREEN_ORIENTATION_REVERSE_PORTRAIT;\n          break;\n        case Surface.ROTATION_270:\n          orientation = ActivityInfo.SCREEN_ORIENTATION_REVERSE_LANDSCAPE;\n          break;\n        default:\n          Log.e(TAG, \"Unknown screen orientation. Defaulting to portrait.\");\n          orientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT;\n          break;\n      }\n    }\n    // if the device's natural orientation is landscape or if the device is square:\n    else {\n      switch (rotation) {\n        case Surface.ROTATION_0:\n          orientation = ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE;\n          break;\n        case Surface.ROTATION_90:\n          orientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT;\n          break;\n        case Surface.ROTATION_180:\n          orientation = ActivityInfo.SCREEN_ORIENTATION_REVERSE_LANDSCAPE;\n          break;\n        case Surface.ROTATION_270:\n          orientation = ActivityInfo.SCREEN_ORIENTATION_REVERSE_PORTRAIT;\n          break;\n        default:\n          Log.e(TAG, \"Unknown screen orientation. Defaulting to landscape.\");\n          orientation = ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE;\n          break;\n      }\n    }\n\n    Log.v(TAG, \"Computed screen orientation: \" + orientation + \", rotation=\" + rotation + \", width=\" + width + \", height=\" + height);\n    return orientation;\n  }",
  "explanation": "code_hardening: Added null checks for the stored Context, ensured it is an Activity before casting, and guarded against null WindowManager and Display. Marked local variables as final where appropriate and provided safe default returns.\nresolve_compilation_errors: Replaced direct getWindowManager() usage with retrieval via the Activity derived from the stored Context. Used existing Android framework classes already present in the file and ensured compatibility by referencing Build.VERSION and Display APIs directly.\nexception_handling: Avoided ClassCastException by checking instanceof Activity before casting. Returned safe default orientations with warning logs instead of throwing exceptions for invalid states.\nlogic_customization: Added API-level conditional logic to use Display.getRotation() on API â‰¥ GINGERBREAD and fall back to Display.getOrientation() on older versions. Preserved the original orientation-determination logic and added a verbose log reporting the computed orientation before returning.\nrefactoring: Kept the existing method name to match current callers, but improved readability by centralizing rotation retrieval and clearly naming local variables.\nmisc: Added descriptive Log.v and Log.w messages consistent with the class TAG for easier debugging. No new custom APIs beyond the Android framework were introduced."
}