

package hu.belicza.andras.util;

import java.awt.Rectangle;
import java.awt.image.BufferedImage;
import java.awt.image.ColorModel;
import java.awt.image.DataBuffer;
import java.awt.image.DataBufferInt;
import java.awt.image.DataBufferUShort;
import java.awt.image.DirectColorModel;
import java.awt.image.Raster;
import java.awt.image.WritableRaster;

import com.sun.jna.Native;
import com.sun.jna.platform.win32.WinGDI;
import com.sun.jna.platform.win32.WinDef.HBITMAP;
import com.sun.jna.platform.win32.WinDef.HDC;
import com.sun.jna.platform.win32.WinDef.HWND;
import com.sun.jna.platform.win32.WinGDI.BITMAPINFO;
import com.sun.jna.platform.win32.WinGDI.BITMAPINFOHEADER;
import com.sun.jna.platform.win32.WinNT.HANDLE;
import com.sun.jna.win32.W32APIOptions;


public class OrigJNAScreenShot {
	
	public static BufferedImage getScreenshot( final Rectangle bounds ) {
		HDC windowDC = GDI.GetDC( USER.GetDesktopWindow() );
		HBITMAP outputBitmap = GDI.CreateCompatibleBitmap( windowDC, bounds.width, bounds.height );
		try {
			HDC blitDC = GDI.CreateCompatibleDC( windowDC );
			try {
				HANDLE oldBitmap = GDI.SelectObject( blitDC, outputBitmap );
				try {
					GDI.BitBlt( blitDC, 0, 0, bounds.width, bounds.height, windowDC, bounds.x, bounds.y, GDI32.SRCCOPY );
				} finally {
					GDI.SelectObject( blitDC, oldBitmap );
				}
				BITMAPINFO bi = new BITMAPINFO( 40 );
				bi.bmiHeader.biSize = 40;
				boolean ok = GDI.GetDIBits( blitDC, outputBitmap, 0, bounds.height, (byte[]) null, bi, WinGDI.DIB_RGB_COLORS );
				if ( ok ) {
					BITMAPINFOHEADER bih = bi.bmiHeader;
					bih.biHeight = -Math.abs( bih.biHeight );
					bi.bmiHeader.biCompression = 0;
					return bufferedImageFromBitmap( blitDC, outputBitmap, bi );
				} else
					return null;
			} finally {
				GDI.DeleteObject( blitDC );
			}
		} finally {
			GDI.DeleteObject( outputBitmap );
		}
	}
	
	// TODO

	
	private static final User32 USER = User32.INSTANCE;
	
	private static final GDI32 GDI = GDI32.INSTANCE;
	
}

interface GDI32 extends com.sun.jna.platform.win32.GDI32 {
	GDI32 INSTANCE = (GDI32) Native.loadLibrary( GDI32.class );
	boolean BitBlt( HDC hdcDest, int nXDest, int nYDest, int nWidth, int nHeight, HDC hdcSrc, int nXSrc, int nYSrc, int dwRop );
	HDC GetDC( HWND hWnd );
	boolean GetDIBits( HDC dc, HBITMAP bmp, int startScan, int scanLines, byte[] pixels, BITMAPINFO bi, int usage );
	boolean GetDIBits( HDC dc, HBITMAP bmp, int startScan, int scanLines, short[] pixels, BITMAPINFO bi, int usage );
	boolean GetDIBits( HDC dc, HBITMAP bmp, int startScan, int scanLines, int[] pixels, BITMAPINFO bi, int usage );
	int SRCCOPY = 0xCC0020;
}

interface User32 extends com.sun.jna.platform.win32.User32 {
	User32 INSTANCE = (User32) Native.loadLibrary( User32.class, W32APIOptions.UNICODE_OPTIONS );
	HWND GetDesktopWindow();
}
