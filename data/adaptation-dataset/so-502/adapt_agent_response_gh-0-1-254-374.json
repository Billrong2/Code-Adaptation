{
  "code": "public static Map<String, File> getAllStorageLocations() {\n    final Map<String, File> map = new HashMap<String, File>(10);\n\n    final List<String> mMounts = new ArrayList<String>(10);\n    final List<String> mVold = new ArrayList<String>(10);\n    mMounts.add(\"/mnt/sdcard\");\n    mVold.add(\"/mnt/sdcard\");\n\n    // Parse /proc/mounts\n    try {\n        final File mountFile = new File(\"/proc/mounts\");\n        if (mountFile.exists()) {\n            try (Scanner scanner = new Scanner(mountFile)) {\n                while (scanner.hasNextLine()) {\n                    final String line = scanner.nextLine();\n                    if (line.startsWith(\"/dev/block/vold/\")) {\n                        final String[] lineElements = line.split(\" \");\n                        if (lineElements.length > 1) {\n                            final String element = lineElements[1];\n                            if (!\"/mnt/sdcard\".equals(element)) {\n                                mMounts.add(element);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    } catch (SecurityException e) {\n        Log.w(TAG, \"Unable to read /proc/mounts\", e);\n    }\n\n    // Parse vold.fstab\n    try {\n        final File voldFile = new File(\"/system/etc/vold.fstab\");\n        if (voldFile.exists()) {\n            try (Scanner scanner = new Scanner(voldFile)) {\n                while (scanner.hasNextLine()) {\n                    final String line = scanner.nextLine();\n                    if (line.startsWith(\"dev_mount\")) {\n                        final String[] lineElements = line.split(\" \");\n                        if (lineElements.length > 2) {\n                            String element = lineElements[2];\n                            final int idx = element.indexOf(\":\");\n                            if (idx > 0) {\n                                element = element.substring(0, idx);\n                            }\n                            if (!\"/mnt/sdcard\".equals(element)) {\n                                mVold.add(element);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    } catch (SecurityException e) {\n        Log.w(TAG, \"Unable to read vold.fstab\", e);\n    }\n\n    // Keep only mounts present in vold\n    for (int i = 0; i < mMounts.size(); i++) {\n        final String mount = mMounts.get(i);\n        if (!mVold.contains(mount)) {\n            mMounts.remove(i--);\n        }\n    }\n    mVold.clear();\n\n    // Deduplicate by content hash (as per original logic)\n    final List<String> mountHash = new ArrayList<String>(10);\n    for (String mount : mMounts) {\n        final File root = new File(mount);\n        if (root.exists() && root.isDirectory() && root.canWrite()) {\n            final File[] list = root.listFiles();\n            final StringBuilder hashBuilder = new StringBuilder(\"[\");\n            if (list != null) {\n                for (File f : list) {\n                    hashBuilder.append(f.getName().hashCode()).append(':').append(f.length()).append(\", \");\n                }\n            }\n            hashBuilder.append(']');\n            final String hash = hashBuilder.toString();\n            if (!mountHash.contains(hash)) {\n                String key = SD_CARD + \"_\" + map.size();\n                if (map.size() == 0) {\n                    key = SD_CARD;\n                } else if (map.size() == 1) {\n                    key = EXTERNAL_SD_CARD;\n                }\n                mountHash.add(hash);\n                map.put(key, root);\n            }\n        }\n    }\n    mMounts.clear();\n\n    // Always include the standard external storage directory\n    try {\n        final File defaultExt = Environment.getExternalStorageDirectory();\n        if (defaultExt != null && defaultExt.exists() && defaultExt.isDirectory()) {\n            boolean exists = false;\n            for (File f : map.values()) {\n                if (defaultExt.equals(f)) {\n                    exists = true;\n                    break;\n                }\n            }\n            if (!exists) {\n                map.put(map.isEmpty() ? SD_CARD : (map.containsKey(EXTERNAL_SD_CARD) ? SD_CARD + \"_\" + map.size() : EXTERNAL_SD_CARD), defaultExt);\n            }\n        }\n    } catch (SecurityException e) {\n        Log.w(TAG, \"Unable to access default external storage\", e);\n    }\n\n    // Augment with environment variables\n    try {\n        final String envExternal = System.getenv(\"EXTERNAL_STORAGE\");\n        if (envExternal != null) {\n            final File f = new File(envExternal);\n            if (f.exists() && f.isDirectory() && f.canWrite()) {\n                boolean exists = false;\n                for (File existing : map.values()) {\n                    if (existing.equals(f)) {\n                        exists = true;\n                        break;\n                    }\n                }\n                if (!exists) {\n                    map.put(SD_CARD + \"_\" + map.size(), f);\n                }\n            }\n        }\n\n        final String envSecondary = System.getenv(\"SECONDARY_STORAGE\");\n        if (envSecondary != null) {\n            final String[] paths = envSecondary.split(File.pathSeparator);\n            for (String p : paths) {\n                if (p == null || p.length() == 0) continue;\n                final File f = new File(p);\n                if (f.exists() && f.isDirectory() && f.canWrite()) {\n                    boolean exists = false;\n                    for (File existing : map.values()) {\n                        if (existing.equals(f)) {\n                            exists = true;\n                            break;\n                        }\n                    }\n                    if (!exists) {\n                        map.put(SD_CARD + \"_\" + map.size(), f);\n                    }\n                }\n            }\n        }\n    } catch (SecurityException e) {\n        Log.w(TAG, \"Unable to read storage environment variables\", e);\n    }\n\n    return map;\n}",
  "explanation": "code_hardening: Used try-with-resources for all Scanner instances, added null/existence/directory/writable checks for all discovered paths, validated environment-variable-derived paths, and guarded access to Environment.getExternalStorageDirectory() with null and SecurityException checks.\nresolve_compilation_errors: Preserved existing project constants SD_CARD and EXTERNAL_SD_CARD and reused available Android/Java types already present in the codebase (Map, HashMap, File, Scanner, Environment, Log). No missing symbols were introduced.\nexception_handling: Replaced broad exception handling with targeted SecurityException catches around filesystem and environment access, logging warnings via android.util.Log to match project style while allowing graceful continuation.\nlogic_customization: Kept mount/vold parsing and content-hash deduplication logic intact, ensured the standard external storage directory is always included even when the map is non-empty, and augmented discovery using EXTERNAL_STORAGE and SECONDARY_STORAGE environment variables while avoiding duplicates by comparing against existing map values.\nrefactoring: Simplified string/hash building with StringBuilder, clarified variable names, and structured insertion logic inline to avoid altering behavior while improving readability within the single function.\nmisc: Added brief log messages for failure scenarios and comments documenting environment-variable-based augmentation; no new custom APIs beyond System.getenv(String) and android.os.Environment methods were introduced."
}