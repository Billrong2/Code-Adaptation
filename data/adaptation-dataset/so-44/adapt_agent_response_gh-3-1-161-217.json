{
"code":"private static byte[] createFakeSms2(Context context, String sender, String body) {\n    if (sender == null || sender.length() == 0 || body == null) {\n        Log.e(TAG, \"createFakeSms2: sender or body is null/empty\");\n        return null;\n    }\n\n    // Service center address (dummy)\n    byte[] scBytes = PhoneNumberUtils.networkPortionToCalledPartyBCD(\"0000000000\");\n    byte[] senderBytes = PhoneNumberUtils.networkPortionToCalledPartyBCD(sender);\n    int lsmcs = scBytes != null ? scBytes.length : 0;\n\n    // Prepare timestamp\n    Calendar calendar = new GregorianCalendar();\n    byte[] dateBytes = new byte[7];\n    dateBytes[0] = reverseByte((byte) (calendar.get(Calendar.YEAR)));\n    dateBytes[1] = reverseByte((byte) (calendar.get(Calendar.MONTH) + 1));\n    dateBytes[2] = reverseByte((byte) (calendar.get(Calendar.DAY_OF_MONTH)));\n    dateBytes[3] = reverseByte((byte) (calendar.get(Calendar.HOUR_OF_DAY)));\n    dateBytes[4] = reverseByte((byte) (calendar.get(Calendar.MINUTE)));\n    dateBytes[5] = reverseByte((byte) (calendar.get(Calendar.SECOND)));\n    dateBytes[6] = reverseByte((byte) ((calendar.get(Calendar.ZONE_OFFSET) + calendar.get(Calendar.DST_OFFSET)) / (60 * 1000 * 15)));\n\n    // Encoding selection\n    byte[] userData = null;\n    byte dcs;\n    boolean useGsm7 = false;\n\n    try {\n        // Try GSM 7-bit via internal API\n        Class<?> gsmAlphabet = Class.forName(\"com.android.internal.telephony.GsmAlphabet\");\n        Method stringToGsm7BitPacked = gsmAlphabet.getMethod(\"stringToGsm7BitPacked\", String.class);\n        userData = (byte[]) stringToGsm7BitPacked.invoke(null, body);\n        if (userData != null) {\n            useGsm7 = true;\n            dcs = 0x00; // GSM 7-bit default\n            Log.i(TAG, \"createFakeSms2: using GSM 7-bit encoding\");\n        } else {\n            throw new UnsupportedEncodingException(\"GSM 7-bit returned null\");\n        }\n    } catch (Exception e) {\n        // Fallback to UCS-2\n        try {\n            userData = encodeUCS2(body, null);\n            dcs = 0x08; // UCS-2\n            Log.i(TAG, \"createFakeSms2: falling back to UCS-2 encoding\");\n        } catch (Exception ucs2e) {\n            Log.e(TAG, \"createFakeSms2: unsupported encoding for body\", ucs2e);\n            return null;\n        }\n    }\n\n    // Build PDU\n    try (ByteArrayOutputStream bo = new ByteArrayOutputStream()) {\n        bo.write(lsmcs);\n        if (scBytes != null) {\n            bo.write(scBytes);\n        }\n        bo.write(0x04); // SMS-DELIVER\n        bo.write((byte) sender.length());\n        bo.write(senderBytes);\n        bo.write(0x00); // PID\n        bo.write(useGsm7 ? 0x00 : 0x08); // DCS after encoding decision\n        bo.write(dateBytes); // Timestamp after encoding decision\n        bo.write(userData);\n        return bo.toByteArray();\n    } catch (IOException ioe) {\n        Log.e(TAG, \"createFakeSms2: IO error while building PDU\", ioe);\n        return null;\n    }\n}",
"explanation":"code_hardening: Added null/empty checks for sender and body, validated service-center bytes, used try-with-resources for ByteArrayOutputStream, and ensured timestamp fields are always initialized before use.\nresolve_compilation_errors: Removed all Intent/startService logic and kept only PDU construction; updated the method to return byte[] with the name createFakeSms2 as used by addAccount; relied on existing reverseByte and encodeUCS2 helpers and used reflection with fully qualified class names for GsmAlphabet.\nexception_handling: Replaced empty catch blocks with explicit logging and clear fallback behavior; distinguished GSM 7-bit reflection failures from UCS-2 encoding failures and returned null on unrecoverable errors.\nlogic_customization: Chose encoding first by attempting GSM 7-bit via com.android.internal.telephony.GsmAlphabet.stringToGsm7BitPacked(String), falling back to UCS-2 via encodeUCS2; set DCS to 0x00 for GSM 7-bit and 0x08 for UCS-2; wrote DCS and timestamp only after encoding choice and appended the correctly encoded user data.\nrefactoring: Renamed the method to reflect PDU-building responsibility, clarified local variable names (userData, dcs, useGsm7), and removed unused intent-related logic; replaced magic DCS values with explicit comments.\nmisc: Added TAG-based logging for chosen encoding and error cases and updated comments to reflect that the method now only builds and returns an SMS PDU; no additional custom APIs beyond the internal GsmAlphabet reflection were introduced."}