{
  "code": "public URI getLocationURI(final HttpResponse response, final HttpContext context) throws ProtocolException {\n    if (response == null) {\n        throw new IllegalArgumentException(\"HTTP response may not be null\");\n    }\n\n    // get the location header to find out where to redirect to\n    Header locationHeader = response.getFirstHeader(\"location\");\n    if (locationHeader == null) {\n        // got a redirect response, but no location header\n        throw new ProtocolException(\n                \"Received redirect response \" + response.getStatusLine()\n                        + \" but no location header\"\n        );\n    }\n\n    // preserve space-to-%20 replacement before URI construction\n    String location = locationHeader.getValue().replaceAll(\" \", \"%20\");\n\n    URI uri;\n    try {\n        uri = new URI(location);\n    } catch (URISyntaxException ex) {\n        throw new ProtocolException(\"Invalid redirect URI: \" + location, ex);\n    }\n\n    HttpParams params = response.getParams();\n\n    // rfc2616 demands the location value be a complete URI\n    // Location = \"Location\" \":\" absoluteURI\n    if (!uri.isAbsolute()) {\n        if (params.isParameterTrue(ClientPNames.REJECT_RELATIVE_REDIRECT)) {\n            throw new ProtocolException(\"Relative redirect location '\" + uri + \"' not allowed\");\n        }\n\n        // Adjust location URI\n        HttpHost target = (HttpHost) context.getAttribute(ExecutionContext.HTTP_TARGET_HOST);\n        if (target == null) {\n            throw new IllegalStateException(\"Target host not available in the HTTP context\");\n        }\n\n        HttpRequest request = (HttpRequest) context.getAttribute(ExecutionContext.HTTP_REQUEST);\n\n        try {\n            URI requestURI = new URI(request.getRequestLine().getUri());\n            URI absoluteRequestURI = URIUtils.rewriteURI(requestURI, target, true);\n            uri = URIUtils.resolve(absoluteRequestURI, uri);\n        } catch (URISyntaxException ex) {\n            throw new ProtocolException(ex.getMessage(), ex);\n        }\n    }\n\n    if (params.isParameterFalse(ClientPNames.ALLOW_CIRCULAR_REDIRECTS)) {\n        RedirectLocations redirectLocations = (RedirectLocations) context.getAttribute(REDIRECT_LOCATIONS);\n\n        if (redirectLocations == null) {\n            redirectLocations = new RedirectLocations();\n            context.setAttribute(REDIRECT_LOCATIONS, redirectLocations);\n        }\n\n        URI redirectURI;\n        if (uri.getFragment() != null) {\n            try {\n                HttpHost target = new HttpHost(uri.getHost(), uri.getPort(), uri.getScheme());\n                redirectURI = URIUtils.rewriteURI(uri, target, true);\n            } catch (URISyntaxException ex) {\n                throw new ProtocolException(ex.getMessage(), ex);\n            }\n        } else {\n            redirectURI = uri;\n        }\n\n        if (redirectLocations.contains(redirectURI)) {\n            throw new CircularRedirectException(\"Circular redirect to '\" + redirectURI + \"'\");\n        } else {\n            redirectLocations.add(redirectURI);\n        }\n    }\n\n    return uri;\n}",
  "explanation": "code_hardening: none\nresolve_compilation_errors: Preserved the existing method signature expected by DefaultRedirectHandler and used the same Apache HttpClient APIs (ClientPNames, RedirectLocations, URIUtils, ExecutionContext) already present in the codebase; no API substitutions or new declarations were introduced.\nexception_handling: Retained all original exception behavior exactly as-is, including IllegalArgumentException, ProtocolException, CircularRedirectException, and URISyntaxException wrapping, with no added or removed try/catch blocks.\nlogic_customization: none\nrefactoring: Applied formatting-only refactoring: consistent indentation, brace placement, spacing, and line wrapping for readability without renaming variables, altering control flow, or changing logic.\nmisc: Reformatted comments to align with the updated layout while preserving their original content and intent; no new comments or logging added."
}