{
  "code": "private static int calculateInSampleSize(android.graphics.BitmapFactory.Options options, int reqWidth, int reqHeight) {\n    // Guard against invalid input\n    if (options == null || options.outWidth <= 0 || options.outHeight <= 0 || reqWidth <= 0 || reqHeight <= 0) {\n        android.util.Log.d(\"calculateInSampleSize\", \"Invalid options or requested size; defaulting inSampleSize=1\");\n        return 1;\n    }\n\n    final int originalWidth = options.outWidth;\n    final int originalHeight = options.outHeight;\n    int inSampleSize = 1;\n\n    android.util.Log.d(\"calculateInSampleSize\", \"Requested width=\" + reqWidth + \", height=\" + reqHeight);\n    android.util.Log.d(\"calculateInSampleSize\", \"Original width=\" + originalWidth + \", height=\" + originalHeight);\n\n    if (originalHeight > reqHeight || originalWidth > reqWidth) {\n        // Initial ratios (preserve min(heightRatio, widthRatio) logic)\n        final int heightRatio = Math.round((float) originalHeight / (float) reqHeight);\n        final int widthRatio = Math.round((float) originalWidth / (float) reqWidth);\n        inSampleSize = heightRatio < widthRatio ? heightRatio : widthRatio;\n        if (inSampleSize < 1) {\n            inSampleSize = 1;\n        }\n    }\n\n    android.util.Log.d(\"calculateInSampleSize\", \"Initial inSampleSize=\" + inSampleSize);\n\n    // Bias toward rounding up: ensure scaled dimensions do not exceed requested bounds\n    int scaledWidth = originalWidth / inSampleSize;\n    int scaledHeight = originalHeight / inSampleSize;\n    while ((scaledWidth > reqWidth || scaledHeight > reqHeight)) {\n        inSampleSize++;\n        scaledWidth = originalWidth / inSampleSize;\n        scaledHeight = originalHeight / inSampleSize;\n    }\n\n    if (inSampleSize < 1) {\n        inSampleSize = 1;\n    }\n\n    android.util.Log.d(\"calculateInSampleSize\", \"Final inSampleSize=\" + inSampleSize + \", scaledWidth=\" + scaledWidth + \", scaledHeight=\" + scaledHeight);\n    return inSampleSize;\n}",
  "explanation": "code_hardening: Added guards for null options, non-positive outWidth/outHeight, and non-positive requested dimensions to avoid division by zero and return a safe default of 1; clamped inSampleSize to a minimum of 1 after adjustments.\nresolve_compilation_errors: Used fully qualified references to android.graphics.BitmapFactory.Options and android.util.Log to ensure the function compiles standalone within the existing file context.\nexception_handling: none.\nlogic_customization: Preserved the initial min(heightRatio, widthRatio) computation, then calculated scaled dimensions and incremented inSampleSize until both scaled width and height are less than or equal to the requested bounds, biasing toward further downscaling to avoid oversizing.\nrefactoring: Renamed locals for clarity (originalWidth/originalHeight, scaledWidth/scaledHeight) and structured the scaled-dimension adjustment loop for readability while keeping the method signature unchanged.\nmisc: Added debug logging for requested dimensions, original dimensions, initial inSampleSize, and final adjusted inSampleSize using a consistent tag; no new custom API calls were introduced."
}