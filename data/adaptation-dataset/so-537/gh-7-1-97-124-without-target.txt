

package org.geotoolkit.data.nmea;

import gnu.io.CommPortIdentifier;
import java.io.InputStream;
import java.lang.reflect.Field;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Arrays;
import java.util.Locale;
import java.util.Properties;
import java.util.logging.Level;
import java.util.logging.Logger;
import org.apache.sis.util.logging.Logging;
import org.geotoolkit.internal.SetupService;
import org.geotoolkit.nio.IOUtilities;


public class SetupNMEA implements SetupService {

    private static final Logger LOGGER = Logging.getLogger("org.geotoolkit.data.nmea");
    private static final String LIB8PATH = "/lib";
    private static final String[] RXTX_LIB_NAMES = new String[] {
      "rxtxSerial",
      "rxtxParallel",
      "rxtxI2C",
      "rxtxRaw",
      "rxtxRS485"
    };

    @Override
    public void initialize(final Properties properties, final boolean reinit) {

        try {
            
            final Path tmpFolder = Files.createTempDirectory("geotk_nmea_lib");
            
            addLibraryPath(tmpFolder.toAbsolutePath().toString());

            
            String osName = System.getProperty("os.name").toLowerCase(Locale.ENGLISH);
            if (osName.contains("windows")) {
                osName = "windows";
            } else if (osName.contains("mac")) {
                osName = "mac";
            }
            final StringBuilder libDirBuilder = new StringBuilder(LIB8PATH);
            libDirBuilder.append('/')
                    .append(System.getProperty("os.arch"))
                    .append('/')
                    .append(osName)
                    .append('/');

            final String libDir = libDirBuilder.toString();

            for (final String libName : RXTX_LIB_NAMES) {
                final String libFile = System.mapLibraryName(libName);
                final InputStream resource = SetupNMEA.class.getResourceAsStream(libDir + libFile);
                final Path tmpFile = tmpFolder.resolve(libFile);
                IOUtilities.writeStream(resource, tmpFile);
            }

           CommPortIdentifier.getPortIdentifiers();

        } catch (Exception ex) {
            LOGGER.log(Level.WARNING, "A problem occured while loading RXTX native libraries. Port communication might not work.", ex);
        } catch (UnsatisfiedLinkError er){
            LOGGER.log(Level.INFO, "A problem occured while loading RXTX native libraries. Library not found for "+System.getProperty("os.name")+" "+System.getProperty("os.arch")+" architecture.");
        }

    }

    @Override
    public void shutdown() {
    }

        // TODO


}
