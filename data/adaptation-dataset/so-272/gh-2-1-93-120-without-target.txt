

package org.bytedeco.javacpp.indexer;

import java.nio.ShortBuffer;
import org.bytedeco.javacpp.ShortPointer;


public abstract class HalfIndexer extends Indexer {
    
    public static final int VALUE_BYTES = 2;

    protected HalfIndexer(long[] sizes, long[] strides) {
        super(sizes, strides);
    }

    
    public static HalfIndexer create(short[] array) {
        return new HalfArrayIndexer(array);
    }
    
    public static HalfIndexer create(ShortBuffer buffer) {
        return new HalfBufferIndexer(buffer);
    }
    
    public static HalfIndexer create(ShortPointer pointer) {
        return create(pointer, new long[] { pointer.limit() - pointer.position() }, ONE_STRIDE);
    }

    
    public static HalfIndexer create(short[] array, long[] sizes, long[] strides) {
        return new HalfArrayIndexer(array, sizes, strides);
    }
    
    public static HalfIndexer create(ShortBuffer buffer, long[] sizes, long[] strides) {
        return new HalfBufferIndexer(buffer, sizes, strides);
    }
    
    public static HalfIndexer create(ShortPointer pointer, long[] sizes, long[] strides) {
        return create(pointer, sizes, strides, true);
    }
    
    public static HalfIndexer create(final ShortPointer pointer, long[] sizes, long[] strides, boolean direct) {
        if (direct) {
            return Raw.getInstance() != null ? new HalfRawIndexer(pointer, sizes, strides)
                                             : new HalfBufferIndexer(pointer.asBuffer(), sizes, strides);
        } else {
            final long position = pointer.position();
            short[] array = new short[(int)Math.min(pointer.limit() - position, Integer.MAX_VALUE)];
            pointer.get(array);
            return new HalfArrayIndexer(array, sizes, strides) {
                @Override public void release() {
                    pointer.position(position).put(array);
                    super.release();
                }
            };
        }
    }

    
    

        // TODO


    
    public static int fromFloat( float fval )
    {
        int fbits = Float.floatToIntBits( fval );
        int sign = fbits >>> 16 & 0x8000;          
        int val = ( fbits & 0x7fffffff ) + 0x1000; 

        if( val >= 0x47800000 )               
        {                                     
            if( ( fbits & 0x7fffffff ) >= 0x47800000 )
            {                                 
                if( val < 0x7f800000 )        
                    return sign | 0x7c00;     
                return sign | 0x7c00 |        
                    ( fbits & 0x007fffff ) >>> 13; 
            }
            return sign | 0x7bff;             
        }
        if( val >= 0x38800000 )               
            return sign | val - 0x38000000 >>> 13; 
        if( val < 0x33000000 )                
            return sign;                      
        val = ( fbits & 0x7fffffff ) >>> 23;  
        return sign | ( ( fbits & 0x7fffff | 0x800000 ) 
             + ( 0x800000 >>> val - 102 )     
          >>> 126 - val );   
    }

    
    public abstract float get(long i);
    
    public HalfIndexer get(long i, float[] h) { return get(i, h, 0, h.length); }
    
    public abstract HalfIndexer get(long i, float[] h, int offset, int length);
    
    public abstract float get(long i, long j);
    
    public HalfIndexer get(long i, long j, float[] h) { return get(i, j, h, 0, h.length); }
    
    public abstract HalfIndexer get(long i, long j, float[] h, int offset, int length);
    
    public abstract float get(long i, long j, long k);
    
    public abstract float get(long... indices);
    
    public HalfIndexer get(long[] indices, float[] h) { return get(indices, h, 0, h.length); }
    
    public abstract HalfIndexer get(long[] indices, float[] h, int offset, int length);

    
    public abstract HalfIndexer put(long i, float h);
    
    public HalfIndexer put(long i, float... h) { return put(i, h, 0, h.length); }
    
    public abstract HalfIndexer put(long i, float[] h, int offset, int length);
    
    public abstract HalfIndexer put(long i, long j, float h);
    
    public HalfIndexer put(long i, long j, float... h) { return put(i, j, h, 0, h.length); }
    
    public abstract HalfIndexer put(long i, long j, float[] h, int offset, int length);
    
    public abstract HalfIndexer put(long i, long j, long k, float h);
    
    public abstract HalfIndexer put(long[] indices, float h);
    
    public HalfIndexer put(long[] indices, float... h) { return put(indices, h, 0, h.length); }
    
    public abstract HalfIndexer put(long[] indices, float[] h, int offset, int length);

    @Override public double getDouble(long... indices) { return get(indices); }
    @Override public HalfIndexer putDouble(long[] indices, double s) { return put(indices, (float)s); }
}
