{
  "code": "public static String reshape(String Str) {\n    if (Str == null) {\n        return \"\";\n    }\n\n    final String Temp = \" \" + Str + \" \";\n    char pre, at, post;\n    StringBuilder reshapedString = new StringBuilder();\n    int i = 0;\n    final int len = Str.length();\n\n    char post_post;\n    char pre_pre = ' ';\n\n    while (i < len) {\n        pre = Temp.charAt(i);\n        at = Temp.charAt(i + 1);\n        post = (i + 2 < Temp.length()) ? Temp.charAt(i + 2) : ' ';\n\n        int which_case = getCase(at);\n        int what_case_post = getCase(post);\n        int what_case_pre = getCase(pre);\n        int what_case_post_post;\n        int what_case_pre_pre;\n\n        int pre_step = 0;\n        if (what_case_pre == TASHKEEL) {\n            pre = pre_pre;\n            what_case_pre = getCase(pre);\n        }\n        if ((what_case_pre & LEFT_CHAR_MASK) == LEFT_CHAR_MASK) {\n            pre_step = 1;\n        }\n\n        switch (which_case & 0x000F) {\n            case NOTUSED_CHAR:\n            case NOTARABIC_CHAR:\n                reshapedString.append(at);\n                i++;\n                continue;\n\n            case NORIGHT_NOLEFT_CHAR:\n            case TATWEEL_CHAR:\n                reshapedString.append(getShape(at, 0));\n                i++;\n                continue;\n\n            case RIGHT_LEFT_CHAR_LAM:\n                if ((what_case_post & 0x000F) == RIGHT_NOLEFT_CHAR_ALEF) {\n                    reshapedString.append(getShape(post, pre_step + 2));\n                    i = i + 2;\n                    continue;\n                } else if ((what_case_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                    reshapedString.append(getShape(at, 2 + pre_step));\n                    i = i + 1;\n                    continue;\n                } else if (what_case_post == TANWEEN) {\n                    reshapedString.append(getShape(at, pre_step));\n                    i = i + 1;\n                    continue;\n                } else if (what_case_post == TASHKEEL) {\n                    post_post = (i + 3 < Temp.length()) ? Temp.charAt(i + 3) : ' ';\n                    what_case_post_post = getCase(post_post);\n                    if ((what_case_post_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                        reshapedString.append(getShape(at, 2 + pre_step));\n                        i = i + 1;\n                        continue;\n                    } else {\n                        reshapedString.append(getShape(at, pre_step));\n                        i = i + 1;\n                        continue;\n                    }\n                } else {\n                    reshapedString.append(getShape(at, pre_step));\n                    i = i + 1;\n                    continue;\n                }\n\n            case RIGHT_LEFT_CHAR:\n                if ((what_case_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                    reshapedString.append(getShape(at, 2 + pre_step));\n                    i = i + 1;\n                    continue;\n                } else if (what_case_post == TANWEEN) {\n                    reshapedString.append(getShape(at, pre_step));\n                    i = i + 1;\n                    continue;\n                } else if (what_case_post == TASHKEEL) {\n                    post_post = (i + 3 < Temp.length()) ? Temp.charAt(i + 3) : ' ';\n                    what_case_post_post = getCase(post_post);\n                    if ((what_case_post_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                        reshapedString.append(getShape(at, 2 + pre_step));\n                        i = i + 1;\n                        continue;\n                    } else {\n                        reshapedString.append(getShape(at, pre_step));\n                        i = i + 1;\n                        continue;\n                    }\n                } else {\n                    reshapedString.append(getShape(at, pre_step));\n                    i = i + 1;\n                    continue;\n                }\n\n            case RIGHT_NOLEFT_CHAR_ALEF:\n            case RIGHT_NOLEFT_CHAR:\n                reshapedString.append(getShape(at, pre_step));\n                i = i + 1;\n                continue;\n\n            case TASHKEEL:\n                reshapedString.append(getShape(at, 0));\n                i++;\n                pre_pre = pre;\n                continue;\n\n            case TANWEEN:\n                reshapedString.append(getShape(at, 0));\n                i++;\n                pre_pre = pre;\n                continue;\n\n            default:\n                reshapedString.append(getShape(at, 0));\n                i++;\n        }\n    }\n\n    return reshapedString.toString();\n}",
  "explanation": "code_hardening: Added a null check for Str to avoid NullPointerException, added bounds-safe access for Temp.charAt(i + 2) and Temp.charAt(i + 3) by falling back to a space character when out of range, and marked len as final since it is not reassigned.\nresolve_compilation_errors: Aligned the function with the existing ArabicReshape class context, relying on already-declared constants and the existing getCase(char) and getShape(char, int) methods; no new fields or methods were introduced.\nexception_handling: none.\nlogic_customization: none.\nrefactoring: Improved formatting, indentation, and brace placement, grouped variable declarations consistently, and removed commented-out debug lines while preserving all variable names, conditions, and control flow.\nmisc: Standardized whitespace and brace style to match common Java conventions without altering behavior; no new custom API calls were introduced."
}