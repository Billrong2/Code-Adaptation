{
  "code": "public static String reshape_browser(String Str) {\n        if (Str == null || Str.isEmpty()) {\n            return Str;\n        }\n        String Temp = \" \" + Str + \" \";\n        char pre, at, post;\n        StringBuilder reshapedString = new StringBuilder(Str.length());\n        int i = 0;\n        int len = Str.length();\n\n        char post_post;\n        char pre_pre = ' ';\n        boolean pre_can_connect = false;\n\n        while (i < len) {\n            // Safe indexed reads with bounds protection\n            pre = Temp.charAt(i);\n            at = Temp.charAt(i + 1);\n            post = (i + 2 < Temp.length()) ? Temp.charAt(i + 2) : ' ';\n\n            // Normalize Arabic comma (U+060C) to ASCII comma and bypass shaping\n            if (at == '\\u060C') {\n                reshapedString.append(',');\n                pre_can_connect = false;\n                i++;\n                continue;\n            }\n\n            int which_case = getCase(at);\n            int what_case_post = getCase(post);\n            int what_case_pre = getCase(pre);\n            int what_case_post_post;\n\n            int pre_step = 0;\n            if (what_case_pre == TASHKEEL) {\n                pre = pre_pre;\n                what_case_pre = getCase(pre);\n            }\n            if ((what_case_pre & LEFT_CHAR_MASK) == LEFT_CHAR_MASK) {\n                pre_step = 1;\n            }\n\n            switch (which_case & 0x000F) {\n                case NOTUSED_CHAR:\n                case NOTARABIC_CHAR:\n                    reshapedString.append(at);\n                    pre_can_connect = false;\n                    i++;\n                    continue;\n\n                case NORIGHT_NOLEFT_CHAR:\n                    reshapedString.append(getShape(at, 0));\n                    pre_can_connect = false;\n                    i++;\n                    continue;\n\n                case TATWEEL_CHAR:\n                    // Same shaping output, but explicitly reset connectivity\n                    reshapedString.append(getShape(at, 0));\n                    pre_can_connect = false;\n                    i++;\n                    continue;\n\n                case RIGHT_LEFT_CHAR_LAM:\n                    if ((what_case_post & 0x000F) == RIGHT_NOLEFT_CHAR_ALEF) {\n                        reshapedString.append(getShape(post, pre_step + 2));\n                        pre_can_connect = false; // after Lam-Alef\n                        i = i + 2;\n                        continue;\n                    } else if ((what_case_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                        reshapedString.append(getShape(at, 2 + pre_step));\n                        pre_can_connect = true;\n                        i = i + 1;\n                        continue;\n                    } else if (what_case_post == TANWEEN) {\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i = i + 1;\n                        continue;\n                    } else if (what_case_post == TASHKEEL) {\n                        // Do not skip past Tashkeel; inspect immediate next position only\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i = i + 1;\n                        continue;\n                    } else {\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i = i + 1;\n                        continue;\n                    }\n\n                case RIGHT_LEFT_CHAR:\n                    if ((what_case_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                        reshapedString.append(getShape(at, 2 + pre_step));\n                        pre_can_connect = true;\n                        i = i + 1;\n                        continue;\n                    } else if (what_case_post == TANWEEN) {\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i = i + 1;\n                        continue;\n                    } else if (what_case_post == TASHKEEL) {\n                        // Bounds-safe lookahead\n                        if (i + 3 < Temp.length()) {\n                            post_post = Temp.charAt(i + 3);\n                            what_case_post_post = getCase(post_post);\n                            if ((what_case_post_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                                reshapedString.append(getShape(at, 2 + pre_step));\n                                pre_can_connect = true;\n                                i = i + 1;\n                                continue;\n                            }\n                        }\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i = i + 1;\n                        continue;\n                    } else {\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i = i + 1;\n                        continue;\n                    }\n\n                case RIGHT_NOLEFT_CHAR_ALEF:\n                case RIGHT_NOLEFT_CHAR:\n                    reshapedString.append(getShape(at, pre_step));\n                    pre_can_connect = false;\n                    i = i + 1;\n                    continue;\n\n                case TASHKEEL:\n                    reshapedString.append(getShape(at, 0));\n                    pre_pre = pre;\n                    // connectivity depends on following right-joining char\n                    pre_can_connect = false;\n                    i++;\n                    continue;\n\n                case TANWEEN:\n                    reshapedString.append(getShape(at, 0));\n                    pre_pre = pre;\n                    pre_can_connect = false;\n                    i++;\n                    continue;\n\n                default:\n                    reshapedString.append(getShape(at, 0));\n                    pre_can_connect = false;\n                    i++;\n            }\n        }\n        return reshapedString.toString();\n    }",
  "explanation": "code_hardening: Added null/empty input guard, bounds-safe lookahead for i+2 and i+3, and early normalization of Arabic comma (U+060C) to ASCII ',' with shaping bypass. Ensured the connectivity flag is explicitly reset in all non-connecting paths.\nresolve_compilation_errors: Renamed the method to reshape_browser, declared and initialized the new boolean pre_can_connect, and used valid Unicode literal for the Arabic comma. No imports were required.\nexception_handling: none.\nlogic_customization: Implemented Arabic comma normalization and skip shaping. Split NORIGHT_NOLEFT_CHAR and TATWEEL handling so Tatweel explicitly resets connectivity while preserving output. Introduced and maintained pre_can_connect, resetting it for non-Arabic/unused chars, Tatweel, and after Lam-Alef, and setting it when joining to a right-joining next char in Lam and RIGHT_LEFT cases. Adjusted the Lam case when followed by Tashkeel to avoid skipping past the diacritic and make joining decisions based on the immediate next position.\nrefactoring: Renamed the method only and slightly restructured branches to keep connectivity-state updates localized and readable without altering shaping outputs.\nmisc: none."
}