{
  "code": "@Override\npublic void add(HttpUrl url, Cookie cookie)\n{\n    if (url == null || cookie == null)\n        return;\n\n    final String host = url.host();\n    if (host == null || host.length() == 0)\n        return;\n\n    final String token;\n    try\n    {\n        token = getCookieToken(cookie);\n    } catch (IllegalArgumentException e)\n    {\n        Log.d(LOG_TAG, \"IllegalArgumentException in getCookieToken\", e);\n        return;\n    }\n\n    // Non-persistent cookies should not be kept or persisted\n    if (!cookie.persistent())\n    {\n        ConcurrentHashMap<String, Cookie> hostCookies = cookies.get(host);\n        if (hostCookies == null)\n            return;\n\n        hostCookies.remove(token);\n\n        SharedPreferences.Editor prefsWriter = cookiePrefs.edit();\n        prefsWriter.remove(COOKIE_NAME_PREFIX + token);\n        if (!hostCookies.isEmpty())\n        {\n            prefsWriter.putString(host, TextUtils.join(\",\", hostCookies.keySet()));\n        } else\n        {\n            prefsWriter.remove(host);\n        }\n        prefsWriter.apply();\n        return;\n    }\n\n    // Persistent cookie: add or update\n    ConcurrentHashMap<String, Cookie> hostCookies = cookies.get(host);\n    if (hostCookies == null)\n    {\n        hostCookies = new ConcurrentHashMap<String, Cookie>();\n        cookies.put(host, hostCookies);\n    }\n\n    hostCookies.put(token, cookie);\n\n    try\n    {\n        String encodedCookie = encodeCookie(new SerializableHttpCookie(cookie));\n        if (encodedCookie == null)\n            return;\n\n        SharedPreferences.Editor prefsWriter = cookiePrefs.edit();\n        prefsWriter.putString(COOKIE_NAME_PREFIX + token, encodedCookie);\n        prefsWriter.putString(host, TextUtils.join(\",\", hostCookies.keySet()));\n        prefsWriter.apply();\n    } catch (Exception e)\n    {\n        Log.d(LOG_TAG, \"Exception while persisting cookie\", e);\n    }\n}",
  "explanation": "code_hardening: Added null checks for HttpUrl, Cookie, and host; avoided replacing existing per-host maps; safely handled empty host maps when removing; consistently used apply() for SharedPreferences updates.\nresolve_compilation_errors: Implemented an OkHttp-specific add(HttpUrl, Cookie) method using okhttp3.HttpUrl and okhttp3.Cookie; used uri.host() as the key; wrapped cookies with SerializableHttpCookie when calling encodeCookie.\nexception_handling: Guarded getCookieToken with try/catch for IllegalArgumentException; wrapped serialization and persistence in a broad try/catch with logging to avoid crashes on I/O or runtime failures.\nlogic_customization: Changed behavior to single-cookie add/update; used getCookieToken(cookie) as the per-cookie key; only persisted cookies where cookie.persistent() is true; removed non-persistent cookies from existing host maps and returned early if the host map did not exist; updated the host token list and individual cookie entry in SharedPreferences after any add/remove.\nrefactoring: Used OkHttp-centric naming (url, cookie, host, token); consolidated host-map retrieval/update logic inline to avoid duplication; replaced magic strings with COOKIE_NAME_PREFIX.\nmisc: Updated behavior aligns with add/update responsibility rather than construction-time loading; minimal Log.d statements retained for failure visibility; no new custom APIs introduced beyond existing encodeCookie and SerializableHttpCookie."
}