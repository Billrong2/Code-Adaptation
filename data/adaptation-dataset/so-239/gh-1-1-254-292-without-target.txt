package de.visorapp.visor;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.util.Log;
import android.view.View;
import android.view.WindowManager;
import android.widget.FrameLayout;
import android.widget.ImageButton;
import android.widget.Toast;

import java.io.File;
import java.io.FileOutputStream;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import de.visorapp.visor.filters.ColorFilter;


public class VisorActivity extends Activity {
    
    private static final boolean AUTO_HIDE = true;

    
    private static final int AUTO_HIDE_DELAY_MILLIS = 1000;

    
    private static final boolean TOGGLE_ON_CLICK = false;

    
    private static final String TAG = "VisorActivity";

    
    private VisorSurface mVisorView;

    
    private boolean cameraPreviewState = true;

    
    private float prevScreenBrightnewss;

    private View.OnClickListener autoFocusClickHandler = new View.OnClickListener() {
        @Override
        public void onClick(View v) {
            mVisorView.autoFocusCamera();
        }
    };
    private View.OnClickListener colorModeClickHandler = new View.OnClickListener() {
        @Override
        public void onClick(View v) {
            mVisorView.toggleColorMode();
        }
    };
    private View.OnClickListener pauseClickHandler = new View.OnClickListener() {
        @Override
        public void onClick(View v) {
            mVisorView.toggleCameraPreview();
            ImageButton btn = (ImageButton) v;
            if(cameraPreviewState) {
                btn.setImageResource(R.drawable.ic_play_arrow_black_48dp);
                mZoomButton.setImageResource(R.drawable.ic_photo_camera_black_48dp);
                mFlashButton.setAlpha(64);
                mFlashButton.getBackground().setAlpha(64);
            } else {
                btn.setImageResource(R.drawable.ic_pause_black_48dp);
                mZoomButton.setImageResource(R.drawable.ic_add_black_48dp);
                mFlashButton.setAlpha(255);
                mFlashButton.getBackground().setAlpha(255);
            }

            cameraPreviewState = !cameraPreviewState;
        }
    };
    private View.OnClickListener flashLightClickHandler = new View.OnClickListener() {
        @Override
        public void onClick(View v) {
            mVisorView.nextFlashlightMode(getApplicationContext());
        }
    };
    private View.OnClickListener zoomClickHandler = new View.OnClickListener() {
        @Override
        public void onClick(View v) {
            if(cameraPreviewState){
                mVisorView.nextZoomLevel();
                return;
            }

            takeScreenshot();
        }
    };
    private View.OnLongClickListener tapAndHoldListener = new View.OnLongClickListener() {
        @Override
        public boolean onLongClick(View v) {
            mVisorView.toggleAutoFocusMode();
            return true;
        }
    };

    
    private ImageButton mZoomButton;
    private ImageButton mPauseButton;
    private ImageButton mFlashButton;

    
    protected void abortAppWithMessage(CharSequence text) {
        Context context = getApplicationContext();
        int duration = Toast.LENGTH_SHORT;

        Toast toasty = Toast.makeText(context, text, duration);
        toasty.show();

        finish();
    }

    
    protected void setBrightnessToMaximum() {
        WindowManager.LayoutParams layout = getWindow().getAttributes();
        prevScreenBrightnewss = layout.screenBrightness;
        layout.screenBrightness = 1F;
        getWindow().setAttributes(layout);
    }

    
    protected void resetBrightnessToPreviousValue() {
        WindowManager.LayoutParams layout = getWindow().getAttributes();
        layout.screenBrightness = prevScreenBrightnewss;
        getWindow().setAttributes(layout);
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        setContentView(R.layout.activity_visor);

        
        mVisorView = new VisorSurface(this);

        List<ColorFilter> filterList = new ArrayList<ColorFilter>();
        filterList.add(VisorSurface.NO_FILTER);
        filterList.add(VisorSurface.BLACK_WHITE_COLOR_FILTER);
        filterList.add(VisorSurface.WHITE_BLACK_COLOR_FILTER);
        filterList.add(VisorSurface.BLUE_YELLOW_COLOR_FILTER);
        filterList.add(VisorSurface.YELLOW_BLUE_COLOR_FILTER);

        mVisorView.setCameraColorFilters(filterList);
        FrameLayout previewLayout = (FrameLayout) findViewById(R.id.camera_preview);
        previewLayout.addView(mVisorView);

        setButtonListeners();

        
        mVisorView.setOnClickListener(autoFocusClickHandler);
        mVisorView.setOnLongClickListener(tapAndHoldListener);

    }

    
    private void setButtonListeners() {
        
        ImageButton zoomButton = (ImageButton) findViewById(R.id.button_zoom);
        zoomButton.setOnClickListener(zoomClickHandler);

        
        ImageButton flashButton = (ImageButton) findViewById(R.id.button_flash);
        flashButton.setOnClickListener(flashLightClickHandler);

        
        ImageButton colorButton = (ImageButton) findViewById(R.id.button_color);
        colorButton.setOnClickListener(colorModeClickHandler);

        ImageButton pauseButton = (ImageButton) findViewById(R.id.button_pause);
        pauseButton.setOnClickListener(pauseClickHandler);

        mVisorView.setZoomButton(zoomButton);
        mVisorView.setFlashButton(flashButton);

        mZoomButton = zoomButton;
        mPauseButton = pauseButton;
        mFlashButton = flashButton;
    }

    @Override
    protected void onPause() {
        super.onPause();
        
        
        
        Log.d(TAG, "onPause called!");
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        Log.d(TAG, "onDestroy called!");
    }

    @Override
    protected void onResume() {
        super.onResume();

        if(!cameraPreviewState) {
            cameraPreviewState = true;
            mZoomButton.setImageResource(R.drawable.ic_add_black_48dp);
            mPauseButton.setImageResource(R.drawable.ic_pause_black_48dp);
            mFlashButton.setAlpha(255);
            mFlashButton.getBackground().setAlpha(255);
        }

        
        
        
        Log.d(TAG, "onResume called!");
    }

        // TODO


    
    private void openScreenshot(File imageFile) {
        Intent intent = new Intent();
        intent.setAction(Intent.ACTION_VIEW);
        Uri uri = Uri.fromFile(imageFile);
        intent.setDataAndType(uri, "image/*");
        startActivity(intent);
    }
}
