package com.example.utility;

import android.content.Context;
import android.os.Environment;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;



public final class StorageUtility
{
	private StorageUtility() {}


	public static boolean isAvailable()
	{
		String state = Environment.getExternalStorageState();
		return state.equals(Environment.MEDIA_MOUNTED) || state.equals(Environment.MEDIA_MOUNTED_READ_ONLY);
	}


	public static boolean isWritable()
	{
		String state = Environment.getExternalStorageState();
		return state.equals(Environment.MEDIA_MOUNTED);
	}


	public static File getStorageDirectory()
	{
		return Environment.getExternalStorageDirectory();
	}


	
	public static File getStorageDirectory(String publicDirectory)
	{
		return Environment.getExternalStoragePublicDirectory(publicDirectory);
	}


	public static File getSecondaryStorageDirectory()
	{
		return getSecondaryStorageDirectory(null);
	}


	
	public static File getSecondaryStorageDirectory(String publicDirectory)
	{
		File result = null;
		File primary = getStorageDirectory();
		Set<String> externalMounts = getExternalMounts();
		Iterator<String> iterator = externalMounts.iterator();

		while(iterator.hasNext())
		{
			String s = iterator.next();
			if(primary != null && s != null && !s.equals(primary.getAbsolutePath()))
			{
				File secondary = new File(s);
				if(secondary != null && secondary.exists() && secondary.isDirectory())
				{
					String canonicalPrimary = null;
					String canonicalSecondary = null;

					try
					{
						canonicalPrimary = primary.getCanonicalPath();
						canonicalSecondary = secondary.getCanonicalPath();
					}
					catch(IOException e)
					{
						e.printStackTrace();
					}

					if(canonicalPrimary != null && canonicalSecondary != null && !canonicalPrimary.equals(canonicalSecondary))
					{
						if(publicDirectory == null) result = secondary;
						else
						{
							String path = secondary.getAbsolutePath() + "/" + publicDirectory;
							result = new File(path);
						}
					}
				}
			}
		}

		return result;
	}


	public static File getApplicationCacheDirectory(Context context)
	{
		return context.getExternalCacheDir();
	}


	
	public static File getApplicationFilesDirectory(Context context, String type)
	{
		return context.getExternalFilesDir(type);
	}


	public static List<File> getFiles(File directory, boolean recursive)
	{
		List<File> fileList = new ArrayList<>();
		if(directory != null && directory.exists() && directory.isDirectory())
		{
			walkFiles(directory, recursive, null, null, fileList);
		}
		return fileList;
	}


	
	public static List<File> getFiles(File directory, boolean recursive, Pattern fileNameFilter, Pattern directoryNameFilter)
	{
		List<File> fileList = new ArrayList<>();
		if(directory != null && directory.exists() && directory.isDirectory())
		{
			walkFiles(directory, recursive, fileNameFilter, directoryNameFilter, fileList);
		}
		return fileList;
	}


		// TODO



	private static void walkFiles(File directory, boolean recursive, Pattern fileNameFilter, Pattern directoryNameFilter, List<File> fileList)
	{
		File[] list = directory.listFiles();
		for(int i = 0; i < list.length; i++)
		{
			File f = list[i];
			if(f.isDirectory())
			{
				if(recursive)
				{
					if(validateName(f.getName(), directoryNameFilter))
					{
						walkFiles(f, recursive, fileNameFilter, directoryNameFilter, fileList);
					}
				}
			}
			else if(validateName(f.getName(), fileNameFilter))
			{
				fileList.add(f);
			}
		}
	}


	private static boolean validateName(String name, Pattern pattern)
	{
		if(pattern == null) return true;
		else
		{
			Matcher matcher = pattern.matcher(name);
			return matcher.matches();
		}
	}
}
