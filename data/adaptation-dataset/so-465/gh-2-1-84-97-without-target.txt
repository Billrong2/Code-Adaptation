package edu.cmu.graphchi;

import edu.cmu.graphchi.datablocks.BytesToValueConverter;
import edu.cmu.graphchi.engine.VertexInterval;
import edu.cmu.graphchi.io.CompressedIO;

import java.io.*;
import java.util.ArrayList;


public class ChiFilenames {

    public static String vertexDataSuffix = "";

    public static String getFilenameOfVertexData(String baseFilename, BytesToValueConverter valueConv, boolean sparse) {
        return baseFilename + "." + valueConv.sizeOf() + "Bj.vout" + vertexDataSuffix  + (sparse ? ".sparse" : "");
    }

    public static String getFilenameOfDegreeData(String baseFilename, boolean sparse) {
        return baseFilename + "_degsj.bin" + (sparse ? ".sparse" : "");
    }

    public static String getPartStr(int p, int nShards) {
        return "." + p + "_" + nShards;
    }

    public static String getDirnameShardEdataBlock(String edataShardName, int blocksize) {
        if (CompressedIO.isCompressionEnabled()) {
            edataShardName += ".Z.";
        }
        return edataShardName + "_blockdir_" + blocksize;
    }

    public static String getFilenameShardEdataBlock(String edataShardname, int blockId, int blocksize) {

        return getDirnameShardEdataBlock(edataShardname, blocksize) + "/" + blockId;
    }

    public static int getShardEdataSize(String edataShardname) throws IOException {
        String fname = edataShardname + ".size";
        BufferedReader rd = new BufferedReader(new FileReader(new File(fname)));
        String ln = rd.readLine();
        rd.close();
        return Integer.parseInt(ln);
    }

    public static String getFilenameShardEdata(String baseFilename, BytesToValueConverter valueConv, int p, int nShards) {
        return baseFilename + ".edata_java.e" + valueConv.sizeOf() + "B." + p + "_" + nShards;
    }

    public static String getFilenameShardsAdj(String baseFilename, int p, int nShards) {
        return baseFilename + ".edata_java." + p + "_" + nShards + ".adj";
    }

    public static String getFilenameIntervals(String baseFilename, int nShards) {
        return baseFilename + "." + nShards + ".intervalsjava";
    }

    public static String getVertexTranslateDefFile(String baseFilename, int nshards) {
        return baseFilename + "." + nshards + ".vtranslate";
    }

    public static int getBlocksize(int sizeOf) {
        int blocksize = 4096 * 1024;
        while (blocksize % sizeOf != 0) blocksize++;
        assert(blocksize % sizeOf == 0);
        return blocksize;
    }

        // TODO


    public static ArrayList<VertexInterval> loadIntervals(String baseFilename, int nShards)  throws FileNotFoundException, IOException {
        String intervalFilename = ChiFilenames.getFilenameIntervals(baseFilename, nShards);

        BufferedReader rd = new BufferedReader(new FileReader(new File(intervalFilename)));
        String line;
        int lastId = 0;
        ArrayList<VertexInterval> intervals = new ArrayList<VertexInterval>(nShards);
        while((line = rd.readLine()) != null) {
            int vid = Integer.parseInt(line);
            intervals.add(new VertexInterval(lastId, vid));
            lastId = vid + 1;
        }
        return intervals;
    }


    public static int numVertices(String baseFilename, int numShards) throws IOException {
        ArrayList<VertexInterval> intervals = loadIntervals(baseFilename, numShards);
        return intervals.get(intervals.size() - 1).getLastVertex() + 1;
    }
}

