package at.ac.tuwien.infosys.jaxb;

import java.io.ByteArrayOutputStream;
import java.util.HashSet;
import java.util.Set;

import javax.xml.XMLConstants;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;


public class XmlUtil {

	public static String toString(Element element) {
		return toString(element, false);
	}

	@SuppressWarnings("all")
	
	public static synchronized String toString(Element element, boolean indent) {

		ByteArrayOutputStream baos = new ByteArrayOutputStream();
		try {
			Transformer tr = TransformerFactory.newInstance().newTransformer();
			tr.setOutputProperty(OutputKeys.METHOD, "xml");
			if(indent) {
				tr.setOutputProperty(
						"{http://xml.apache.org/xslt}indent-amount", "2");
				tr.setOutputProperty(OutputKeys.INDENT, "yes");
			} else {
				tr.setOutputProperty(OutputKeys.INDENT, "no");
			}
			tr.transform(new DOMSource(element), new StreamResult(baos));
		} catch(Exception e) {
			throw new RuntimeException(e);
		}

		String string = null;
		byte[] bytes = baos.toByteArray();
		string = new String(bytes);
		bytes = null;
		string = string
				.replaceAll(
						"<\\?xml version=\"1\\.0\" (encoding=\".*\")?( )*\\?>(\n)*",
						"");
		return string;
	}

	public static String toStringWithStrippedNamespaces(Element e) {
		try {
			RemoveUnusedNamespaces remove = new RemoveUnusedNamespaces();
			Document d = e.getOwnerDocument();
			remove.process(d);
			return toString(d.getDocumentElement());
		} catch (Exception e2) {
			throw new RuntimeException(e2);
		}
	}
	
	
	public static class RemoveUnusedNamespaces {

	    private interface ElementVisitor {
	        void visit(Element element);
	    }

	    // TODO


	    private final void traverse(Element element, ElementVisitor visitor) {
	        visitor.visit(element);
	        NodeList children = element.getChildNodes();
	        for (int i = 0; i < children.getLength(); i++) {
	            Node node = children.item(i);
	            if (node.getNodeType() != Node.ELEMENT_NODE)
	                continue;
	            traverse((Element) node, visitor);
	        }
	    }

	}

}
