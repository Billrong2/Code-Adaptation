{
  "code": "public void process(final org.w3c.dom.Document document) {\n        if (document == null) {\n            return;\n        }\n        final org.w3c.dom.Element root = document.getDocumentElement();\n        if (root == null) {\n            return;\n        }\n\n        final java.util.Set<String> namespaces = new java.util.HashSet<String>();\n\n        // First traversal: collect all actually used namespaces\n        traverse(root, new ElementVisitor() {\n            public void visit(final org.w3c.dom.Element element) {\n                if (element == null) {\n                    return;\n                }\n                String namespace = element.getNamespaceURI();\n                if (namespace == null) {\n                    namespace = \"\";\n                }\n                namespaces.add(namespace);\n\n                final org.w3c.dom.NamedNodeMap attributes = element.getAttributes();\n                if (attributes == null) {\n                    return;\n                }\n                for (int i = 0; i < attributes.getLength(); i++) {\n                    final org.w3c.dom.Node node = attributes.item(i);\n                    if (node == null) {\n                        continue;\n                    }\n                    // Skip xmlns declarations themselves\n                    if (javax.xml.XMLConstants.XMLNS_ATTRIBUTE_NS_URI.equals(node.getNamespaceURI())) {\n                        continue;\n                    }\n                    final String prefix;\n                    // Special handling for xsi:type\n                    if (javax.xml.XMLConstants.W3C_XML_SCHEMA_INSTANCE_NS_URI.equals(node.getNamespaceURI())) {\n                        if (\"type\".equals(node.getLocalName())) {\n                            final String value = node.getNodeValue();\n                            if (value != null && value.contains(\":\")) {\n                                prefix = value.substring(0, value.indexOf(':'));\n                            } else {\n                                prefix = null;\n                            }\n                        } else {\n                            continue;\n                        }\n                    } else {\n                        prefix = node.getPrefix();\n                    }\n                    String attrNamespace = element.lookupNamespaceURI(prefix);\n                    if (attrNamespace == null) {\n                        attrNamespace = \"\";\n                    }\n                    namespaces.add(attrNamespace);\n                }\n            }\n        });\n\n        // Second traversal: remove unused xmlns declarations\n        traverse(root, new ElementVisitor() {\n            public void visit(final org.w3c.dom.Element element) {\n                if (element == null) {\n                    return;\n                }\n                final java.util.Set<String> removeLocalNames = new java.util.HashSet<String>();\n                final org.w3c.dom.NamedNodeMap attributes = element.getAttributes();\n                if (attributes == null) {\n                    return;\n                }\n                for (int i = 0; i < attributes.getLength(); i++) {\n                    final org.w3c.dom.Node node = attributes.item(i);\n                    if (node == null) {\n                        continue;\n                    }\n                    if (!javax.xml.XMLConstants.XMLNS_ATTRIBUTE_NS_URI.equals(node.getNamespaceURI())) {\n                        continue;\n                    }\n                    if (namespaces.contains(node.getNodeValue())) {\n                        continue;\n                    }\n                    removeLocalNames.add(node.getLocalName());\n                }\n                for (final String localName : removeLocalNames) {\n                    element.removeAttributeNS(javax.xml.XMLConstants.XMLNS_ATTRIBUTE_NS_URI, localName);\n                }\n            }\n        });\n    }",
  "explanation": "code_hardening: Added null checks for Document, document element, Element, NamedNodeMap, and Node instances to avoid NPEs; marked parameters and locals as final where appropriate.\nresolve_compilation_errors: Replaced undefined custom namespace constants with javax.xml.XMLConstants.XMLNS_ATTRIBUTE_NS_URI and javax.xml.XMLConstants.W3C_XML_SCHEMA_INSTANCE_NS_URI; used fully qualified names to avoid import issues.\nexception_handling: none.\nlogic_customization: Updated namespace URI comparisons and removeAttributeNS calls to use XMLConstants.XMLNS_ATTRIBUTE_NS_URI; updated xsi:type handling to use XMLConstants.W3C_XML_SCHEMA_INSTANCE_NS_URI while keeping traversal and collection logic unchanged.\nrefactoring: Replaced magic namespace strings with standardized constants and slightly clarified variable naming (attrNamespace) without altering behavior.\nmisc: none."
}