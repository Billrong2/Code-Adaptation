package edu.cornell.opencomm.view;

import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.Canvas;
import android.graphics.Color;
import android.graphics.Matrix;
import android.graphics.Paint;
import android.graphics.Point;
import android.graphics.PorterDuff;
import android.graphics.PorterDuffXfermode;
import android.graphics.Rect;
import android.graphics.RectF;
import android.util.Log;
import android.util.TypedValue;
import android.widget.ImageButton;
import android.widget.RelativeLayout;
import edu.cornell.opencomm.interfaces.OCUpdateListener;
import edu.cornell.opencomm.manager.UserManager;
import edu.cornell.opencomm.model.ConferenceUser;
import edu.cornell.opencomm.util.OCBitmapDecoder;


public class UserView extends ImageButton implements OCUpdateListener {

	private static String LOG_TAG = UserView.class.getName(); 
	
	
	private Context context;
	
	private ConferenceUser conferenceUser;

	
	

	public UserView(Context context, ConferenceUser conferenceUser) {
		super(context);
		this.context = context;
		this.conferenceUser = conferenceUser;
		this.conferenceUser.addLocationUpdateListner(this);
		init();

		Log.d(LOG_TAG, "Created a UserView for : "
				+ conferenceUser.getUser().getUsername());
	}

	private void init() {
		if (conferenceUser.getUser().compareTo(UserManager.PRIMARY_USER) == 0) {
			setBackgroundColor(Color.BLACK);
		} else {
			setImageBitmap(getImage());
			
		}
		invalidateLocation();
	}
	private void invalidateLocation(){
		RelativeLayout.LayoutParams params = new RelativeLayout.LayoutParams(
				OCBitmapDecoder.THUMBNAIL_WIDTH,OCBitmapDecoder.THUMBNAIL_HEIGTH+5);
		params.leftMargin = conferenceUser.getX();
		params.topMargin = conferenceUser.getY();
		setLayoutParams(params);
	}
	public Point getCurrentLocation() {
		return conferenceUser.getLocation();
	}

	public ConferenceUser getCUser() {
		return conferenceUser;
	}


	
	
	

	// TODO


	public Bitmap getImage() {
		
		Bitmap  bm = getRoundedCornerBitmap(OCBitmapDecoder.getThumbnailFromResource(
				getResources(), conferenceUser.getUser().getImage()));
		int width = bm.getWidth();
        int height = bm.getHeight();
        float scaleWidth = ((float) OCBitmapDecoder.THUMBNAIL_WIDTH)/width;
        float scaleHeight = ((float) OCBitmapDecoder.THUMBNAIL_HEIGTH) / height;
        Matrix matrix = new Matrix();
        matrix.postScale(scaleWidth, scaleHeight);
        return Bitmap.createBitmap(bm, 0, 0, width, height, matrix, true);
	}
	@Override
	public void invalidate() {
		if(conferenceUser != null){
		invalidateLocation();
		}
		super.invalidate();
	}
	public void onUpdate(int eventId, Object data) {
		invalidate();


	}

}
