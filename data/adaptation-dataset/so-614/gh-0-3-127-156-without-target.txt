

package com.commonsware.cwac.provider.test;

import android.content.Context;
import android.content.SharedPreferences;
import android.content.res.Resources.NotFoundException;
import android.database.Cursor;
import android.net.Uri;
import android.os.Build;
import android.os.ParcelFileDescriptor;
import android.provider.OpenableColumns;
import android.support.test.InstrumentationRegistry;
import android.support.test.runner.AndroidJUnit4;
import android.util.Log;
import com.commonsware.cwac.provider.StreamProvider;
import org.junit.Assert;
import org.junit.BeforeClass;
import org.junit.Test;
import org.junit.runner.RunWith;
import java.io.DataInputStream;
import java.io.EOFException;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;

@RunWith(AndroidJUnit4.class)
abstract class AbstractReadOnlyProviderTest {
  private static final String[] COLUMNS= {
    OpenableColumns.DISPLAY_NAME, OpenableColumns.SIZE };
  abstract public InputStream getOriginal() throws IOException;
  abstract public Uri getStreamSource(Uri root);

  static final Uri[] ROOTS={
    Uri.parse("content://"+BuildConfig.APPLICATION_ID+".fixed/"+
        StreamProvider.getUriPrefix(BuildConfig.APPLICATION_ID+".fixed")),
    Uri.parse("content://"+BuildConfig.APPLICATION_ID+".plain/"+
        StreamProvider.getUriPrefix(BuildConfig.APPLICATION_ID+".plain")),
    Uri.parse("content://"+BuildConfig.APPLICATION_ID+".no")
  };

  @BeforeClass
  static public void resetPrefs() {
    SharedPreferences prefs=InstrumentationRegistry.getTargetContext().getSharedPreferences(
      com.commonsware.cwac.provider.BuildConfig.APPLICATION_ID,
      Context.MODE_PRIVATE);

    prefs.edit().clear().commit();
  }

  @Test
  public void testRead() throws NotFoundException, IOException {
    for (Uri root : ROOTS) {
      Uri source=getStreamSource(root);

      InputStream testInput=
        InstrumentationRegistry
          .getContext()
          .getContentResolver()
          .openInputStream(source);
      InputStream testComparison=getOriginal();

      Assert.assertTrue(isEqual(testInput, testComparison));

      Cursor c=InstrumentationRegistry
        .getContext()
        .getContentResolver()
        .query(source, COLUMNS, null, null, null);

      Assert.assertNotNull(c);
      Assert.assertEquals(4, c.getColumnCount());
      Assert.assertEquals(1, c.getCount());

      c.moveToFirst();

      int nameCol=c.getColumnIndex(COLUMNS[0]);
      int sizeCol=c.getColumnIndex(COLUMNS[1]);

      if (Build.VERSION.SDK_INT>=Build.VERSION_CODES.HONEYCOMB) {
        Assert.assertTrue(
          c.getType(nameCol)==Cursor.FIELD_TYPE_STRING);
        Assert.assertNotNull(c.getString(nameCol));
        Assert.assertTrue(
          c.getType(sizeCol)==Cursor.FIELD_TYPE_INTEGER);
        Assert.assertTrue(c.getInt(sizeCol)>0);
      }
    }
  }

  @Test
  public void testCannotWrite() throws IOException {
    for (Uri root : ROOTS) {
      Uri source=getStreamSource(root);

      try {
        ParcelFileDescriptor pfd=
          InstrumentationRegistry
            .getContext()
            .getContentResolver()
            .openFileDescriptor(source, "rw");
        pfd.close();
        Assert.fail("expected exception, did not get one");
      }
      catch (FileNotFoundException e) {
        if (!e.getMessage().equals("Not a whole file") &&
          !e.getMessage().equals("Invalid mode for read-only content")) {
          throw e;
        }
      }
    }
  }

  

  // TODO

}
