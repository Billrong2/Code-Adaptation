{
  "code": "public static boolean addSmiles(final Context context, final Spannable spannable) {\n    if (context == null || spannable == null || emoticons == null) {\n        return false;\n    }\n\n    boolean hasChanges = false;\n\n    for (java.util.Map.Entry<Pattern, Integer> entry : emoticons.entrySet()) {\n        final Matcher matcher = entry.getKey().matcher(spannable);\n        while (matcher.find()) {\n            boolean shouldSetSpan = true;\n            for (ImageSpan span : spannable.getSpans(matcher.start(), matcher.end(), ImageSpan.class)) {\n                if (spannable.getSpanStart(span) >= matcher.start()\n                        && spannable.getSpanEnd(span) <= matcher.end()) {\n                    spannable.removeSpan(span);\n                } else {\n                    shouldSetSpan = false;\n                    break;\n                }\n            }\n            if (shouldSetSpan) {\n                hasChanges = true;\n                spannable.setSpan(\n                        new ImageSpan(context, entry.getValue()),\n                        matcher.start(),\n                        matcher.end(),\n                        Spannable.SPAN_EXCLUSIVE_EXCLUSIVE\n                );\n            }\n        }\n    }\n\n    return hasChanges;\n}",
  "explanation": "code_hardening: Added null-checks for context, spannable, and emoticons at the start of the method to safely short-circuit when inputs are invalid. Marked parameters as final to prevent accidental reassignment within the method.\nresolve_compilation_errors: Replaced the raw Entry type with fully qualified java.util.Map.Entry to avoid ambiguous imports and ensure compilation safety without relying on additional import statements.\nexception_handling: none.\nlogic_customization: none; the matching and span-replacement algorithm is unchanged from the original behavior.\nrefactoring: Added explicit braces to the inner for-loop and its if/else blocks to make control flow unambiguous. Renamed the local variable from 'set' to 'shouldSetSpan' to improve readability.\nmisc: Reformatted indentation and line breaks for consistent style and clearer structure. No new custom API calls were introduced."
}