package diskCacheV111.util;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectInput;
import java.io.ObjectInputStream;
import java.io.ObjectOutput;
import java.io.ObjectOutputStream;
import java.util.ArrayList;
import java.util.List;

import static org.junit.Assert.assertEquals;


public class SerializableUtils {

    private static final int STRING_LINE_LENGTH = 61;

    public static void assertSerialisationExpected( String message,
                                                    String encodedExpected,
                                                    Object object)
            throws IOException {
        String encodedResult =
                SerializableUtils.serialiseAndEncodeObject( object);
        assertEquals( message, encodedExpected, encodedResult);
    }

    public static void assertDeserialisationExpected(
                                                      String message,
                                                      Object expectedObject,
                                                      String encodedSerialisedObject)
            throws ClassNotFoundException, IOException {
        byte[] serialisedData =
                SerializableUtils.decode( encodedSerialisedObject);
        ByteArrayInputStream byteStream =
                new ByteArrayInputStream( serialisedData);
        ObjectInput objectInput = new ObjectInputStream( byteStream);

        Object deserialisedObject = objectInput.readObject();

        assertEquals( message, expectedObject, deserialisedObject);
    }

    public static String serialiseAndEncodeObject( Object object)
            throws IOException {
        ByteArrayOutputStream storage = new ByteArrayOutputStream();
        ObjectOutput objectOutput = new ObjectOutputStream( storage);
        objectOutput.writeObject( object);
        objectOutput.close();

        return SerializableUtils.encode( storage.toByteArray());
    }

    
    public static String encode( byte[] byteStream) {
        StringBuilder result = new StringBuilder();
        for( byte curr : byteStream) {
            result.append(Integer.toString((curr & 0xff) + 0x100, 16)
                    .substring(1));
        }
        return result.toString();
    }

        // TODO


    public static void emitJavaStringDeclaration( String name, String data) {
        List<String> lines = breakStringIntoLines( data);
        String declaration = buildJavaStringDeclaration( name, lines);
        System.out.println( declaration);
    }

    public static String buildJavaStringDeclaration( String name,
                                                     List<String> lines) {
        StringBuilder sb = new StringBuilder();

        sb.append("    private static final String ").append(name)
                .append(" =\n");

        boolean isFirstLine = true;

        for( String line : lines) {
            if( isFirstLine) {
                sb.append("                     ");
            } else {
                sb.append("\n                   + ");
            }
            sb.append("\"").append(line).append("\"");
            isFirstLine = false;
        }

        sb.append( ";\n");

        return sb.toString();
    }

    public static List<String> breakStringIntoLines( String data) {
        List<String> lines = new ArrayList<>();

        String remaining;
        for( String current = data; current.length() > 0; current = remaining) {

            int thisLineLength =
                    current.length() < STRING_LINE_LENGTH ? current.length()
                            : STRING_LINE_LENGTH;

            String thisLine = current.substring( 0, thisLineLength);
            remaining = current.substring( thisLineLength, current.length());

            lines.add( thisLine);
        }

        return lines;
    }

}
