package com.tombarrasso.android.wp7calculator;


import java.text.NumberFormat;
import java.util.Locale;
import java.lang.reflect.Method;


import com.tombarrasso.android.wp7ui.WPFonts;
import com.tombarrasso.android.wp7ui.widget.WPToast;


import android.content.Context;
import android.graphics.Canvas;
import android.text.Layout.Alignment;
import android.content.res.Resources;
import android.text.StaticLayout;
import android.text.TextPaint;
import android.util.AttributeSet;
import android.util.TypedValue;
import android.text.ClipboardManager;
import android.text.TextUtils;
import android.view.ActionMode;
import android.view.ContextMenu;
import android.view.Menu;
import android.view.View;
import android.view.MenuItem;
import android.view.MotionEvent;
import android.widget.TextView;
import android.preference.PreferenceManager;
import android.content.SharedPreferences;
import android.view.HapticFeedbackConstants;
import android.util.Log;


public final class AutoResizeTextView
	extends TextView
{
	public static final String TAG = AutoResizeTextView.class.getSimpleName();
	
	private String[] mMenuItemsStrings;
    
    private static final Class<TextView> mViewClass = TextView.class;
    
    private static Method mMethod;
    
    public static final boolean setCustomSelectionActionModeCallback(
    	View mView, ActionMode.Callback mCallback)
    {
    	
		if (mMethod == null)
		{
			try
			{
				
				mMethod = mViewClass.getMethod("setCustomSelectionActionModeCallback",
					new Class[] { ActionMode.Callback.class });
			}
			catch(NoSuchMethodException e)
			{
				return false;
			}
		}
		
		
		
		
		
		try
		{
			mMethod.invoke(mView,
				new Object[] { mCallback });
		}
		catch(Exception e)
		{
			return false;
		}

		return true;
    }
    
    private static final int CUT = 0;
    private static final int COPY = 1;
    private static final int PASTE = 2;
	
    
    public static final float MIN_TEXT_SIZE = 2;

    
    public interface OnTextResizeListener {
        public void onTextResize(TextView textView, float oldSize, float newSize);
    }

    
    private static final Canvas sTextResizeCanvas = new Canvas();

    
    private static final String mEllipsis = "...";

    
    private OnTextResizeListener mTextResizeListener;

    
    private boolean mNeedsResize = false;

    
    private float mTextSize;

    
    private float mMaxTextSize = 0;

    
    private float mMinTextSize = MIN_TEXT_SIZE;

    
    private float mSpacingMult = 1.0f;

    
    private float mSpacingAdd = -2.0f;

    
    private boolean mAddEllipsis = false;

    
    public AutoResizeTextView(Context context) {
        this(context, null);
        init();
    }

    
    public AutoResizeTextView(Context context, AttributeSet attrs) {
        this(context, attrs, 0);
        init();
    }

    
    public AutoResizeTextView(Context context, AttributeSet attrs, int defStyle) {
        super(context, attrs, defStyle);
        init();
        mTextSize = getTextSize();
    }
    
    private void init()
    {
    	WPFonts.setDefaultFonts(getContext().getResources().getAssets());
    	setTypeface(WPFonts.getFontSet().getRegular());
    	
    	
        mMaxTextSize = this.getTextSize();
    	
    	
    	if (android.os.Build.VERSION.SDK_INT >= 11)
    	{
    		try
    		{
	    		setCustomSelectionActionModeCallback(
	    			this, new NoTextSelectionMode());
	    	}
	    	catch (Throwable e) { }
	    }
    };
    
    
	
	private void refitText(String text, int textWidth) {
		if (textWidth > 0) {
			int availableWidth = textWidth - this.getPaddingLeft() - this.getPaddingRight();
			float trySize = mMaxTextSize;
	
			this.setTextSize(TypedValue.COMPLEX_UNIT_PX, trySize);
			while ((trySize > mMinTextSize) && (this.getPaint().measureText(text) > availableWidth)) {
				trySize -= 1;
				if (trySize <= mMinTextSize) {
					trySize = mMinTextSize;
					break;
				}
				this.setTextSize(TypedValue.COMPLEX_UNIT_PX, trySize);
			}
			this.setTextSize(TypedValue.COMPLEX_UNIT_PX, trySize);
		}
	}
	
	@Override
    protected void onTextChanged(final CharSequence text, final int start, final int before, final int after) {
        mNeedsResize = true;
        refitText(text.toString(), this.getWidth());
    }
    
    private int mWidth;

    @Override
    protected void onSizeChanged (int w, int h, int oldw, int oldh) {
		mNeedsResize = true;
		mWidth = w;
		refitText(this.getText().toString(), this.getWidth());
    }
    
    @Override
    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec)
    {
        super.onMeasure(widthMeasureSpec, heightMeasureSpec);
        int parentWidth = MeasureSpec.getSize(widthMeasureSpec);
        
        
        
    }
    
    
    
    
    private static final NumberFormat nf = NumberFormat.getInstance(Locale.US);
    static {
    	
    	nf.setMaximumFractionDigits(999); 
    };
    
    
    public void setCommaSeparatedText(double num)
    {		
    	try
    	{
	    	super.setText(nf.format(num));
    	}
    	catch (NumberFormatException e)
    	{
    		super.setText(Double.toString(num));
    	}
    }
    
    
    public void setCommaSeparatedText(String text)
    {
    	try
    	{
    		setCommaSeparatedText(Double.parseDouble(HomeActivity.removeChar(text, Constants.Chars.comma)));
    	}
    	catch (NumberFormatException e)
    	{
    		super.setText(text);
    	}
    }

    
    

    
    
    public void setOnResizeListener(OnTextResizeListener listener) {
        mTextResizeListener = listener;
    }

    
    @Override
    public void setTextSize(float size) {
        super.setTextSize(size);
        mTextSize = getTextSize();
    }

    
    @Override
    public void setTextSize(int unit, float size) {
        super.setTextSize(unit, size);
        mTextSize = getTextSize();
    }

    
    @Override
    public void setLineSpacing(float add, float mult) {
        super.setLineSpacing(add, mult);
        mSpacingMult = mult;
        mSpacingAdd = add;
    }

    
    public void setMaxTextSize(float maxTextSize) {
        mMaxTextSize = maxTextSize;
        requestLayout();
        invalidate();
    }

    
    public float getMaxTextSize() {
        return mMaxTextSize;
    }

    
    public void setMinTextSize(float minTextSize) {
        mMinTextSize = minTextSize;
        requestLayout();
        invalidate();
    }

    
    public float getMinTextSize() {
        return mMinTextSize;
    }

    
    public void setAddEllipsis(boolean addEllipsis) {
        mAddEllipsis = addEllipsis;
    }

    
    public boolean getAddEllipsis() {
        return mAddEllipsis;
    }

    
    public void resetTextSize() {
        super.setTextSize(TypedValue.COMPLEX_UNIT_PX, mTextSize);
        mMaxTextSize = mTextSize;
    }
    
    @Override
    public boolean onTouchEvent(MotionEvent event) {
       if ((event.getAction() & MotionEvent.ACTION_MASK) == MotionEvent.ACTION_UP) {
            
           cancelLongPress();
        }
        return super.onTouchEvent(event);
    }
    
    @Override
    public boolean performLongClick() {
    
    	final SharedPreferences mPrefs = PreferenceManager.getDefaultSharedPreferences(getContext().getApplicationContext());
    	final boolean mShouldVibrate = mPrefs.getBoolean(HomeActivity.VIBRATE_KEY, false);
    	
    	
    	if (mShouldVibrate) {
    		performHapticFeedback(HapticFeedbackConstants.VIRTUAL_KEY,
						HapticFeedbackConstants.FLAG_IGNORE_GLOBAL_SETTING |
						HapticFeedbackConstants.FLAG_IGNORE_VIEW_SETTING);
    	}
    
        showContextMenu();
        return true;
    }
    
    private final class MenuHandler implements MenuItem.OnMenuItemClickListener {
    	@Override
        public boolean onMenuItemClick(MenuItem item) {
            return onTextContextMenuItem(item.getTitle());
        }
    }

    public boolean onTextContextMenuItem(CharSequence title) {
        boolean handled = false;
        if (TextUtils.equals(title, mMenuItemsStrings[CUT])) {
            cutContent();
            handled = true;
        } else if (TextUtils.equals(title,  mMenuItemsStrings[COPY])) {
            copyContent();
            handled = true;
        } else if (TextUtils.equals(title,  mMenuItemsStrings[PASTE])) {
            pasteContent();
            handled = true;
        }
        return handled;
    }

    @Override
    public void onCreateContextMenu(ContextMenu menu) {
        MenuHandler handler = new MenuHandler();
        if (mMenuItemsStrings == null) {
            Resources resources = getResources();
            mMenuItemsStrings = new String[3];
            mMenuItemsStrings[CUT] = resources.getString(android.R.string.cut);
            mMenuItemsStrings[COPY] = resources.getString(android.R.string.copy);
            mMenuItemsStrings[PASTE] = resources.getString(android.R.string.paste);
        }
        for (int i = 0; i < mMenuItemsStrings.length; i++) {
            menu.add(Menu.NONE, i, i, mMenuItemsStrings[i]).setOnMenuItemClickListener(handler);
        }
        if (getText().length() == 0) {
            menu.getItem(CUT).setVisible(false);
            menu.getItem(COPY).setVisible(false);
        }
        CharSequence primaryClip = getClipText();
        if (primaryClip == null || !canPaste(primaryClip)) {
            menu.getItem(PASTE).setVisible(false);
        }
    }

    private void setClipText(CharSequence clip) {
        final ClipboardManager clipboard = (ClipboardManager) getContext().
                getSystemService(Context.CLIPBOARD_SERVICE);
        clipboard.setText(clip);
    }

    private void copyContent() {
        final String text = (String) getText();
        int textLength = text.length();
        final ClipboardManager clipboard = (ClipboardManager)
        	getContext().getSystemService(Context.CLIPBOARD_SERVICE);
        clipboard.setText(text);
        
        
        WPToast.makeText(getContext().getApplicationContext(),
        	getContext().getString(R.string.text_copied_toast),
        	WPToast.LENGTH_SHORT).show();
    }

    private void cutContent() {
        final String text = (String) getText();
        int textLength = text.length();
        setClipText(text);
        setText(R.string.zero);
    }

    private CharSequence getClipText() {
        final ClipboardManager clipboard = (ClipboardManager)
        	getContext().getSystemService(Context.CLIPBOARD_SERVICE);
        return clipboard.getText();
    }

    private void pasteContent() {
        CharSequence clip = getClipText();
        if (clip != null) {
			if (canPaste(clip)) {
				setText(clip);
			}
		}
    }

    private boolean canPaste(CharSequence paste) {
        boolean canPaste = true;
        try {
            Float.parseFloat(paste.toString());
        } catch (NumberFormatException e) {
            Log.e(TAG, "Error turning string to integer. Ignoring paste.", e);
            canPaste = false;
        }
        return canPaste;
    }

    private final class NoTextSelectionMode
    	implements ActionMode.Callback
    {
        @Override
        public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
            return false;
        }

        @Override
        public boolean onCreateActionMode(ActionMode mode, Menu menu) {
            copyContent();
            
            return false;
        }

        @Override
        public void onDestroyActionMode(ActionMode mode) {}

        @Override
        public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
            return false;
        }
    }

    
    @Override
    protected void onDraw(Canvas canvas) {
        if(mNeedsResize) {
            resizeText(getWidth(), getHeight());
        }
        
        super.onDraw(canvas);
    }

    
    public void resizeText() {
        int heightLimit = getHeight() - getPaddingBottom() - getPaddingTop();
        int widthLimit = getWidth() - getPaddingLeft() - getPaddingRight();
        resizeText(widthLimit, heightLimit);
    }

        // TODO


    
    private int getTextHeight(CharSequence source, TextPaint paint, int width, float textSize) {
        
        paint.setTextSize(textSize);
        
        StaticLayout layout = new StaticLayout(source, paint, width, Alignment.ALIGN_NORMAL, mSpacingMult, mSpacingAdd, false);
        layout.draw(sTextResizeCanvas);
        return layout.getHeight();
    }

}