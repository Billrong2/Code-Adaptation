package gui;

import gui.forms.GUIMain;
import gui.listeners.PaneMenuListener;
import util.Constants;
import util.Utils;
import util.settings.Settings;

import javax.accessibility.AccessibleComponent;
import javax.swing.*;
import java.awt.*;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseMotionAdapter;
import java.awt.image.BufferedImage;
import java.lang.reflect.Field;
import java.util.ArrayList;


public class DraggableTabbedPane extends JTabbedPane {

    public boolean dragging = false;
    private Image tabImage = null;
    private Point currentMouseLocation = null;
    private int draggedTabIndex = 0;

    private TabType toPlace = null;

    public DraggableTabbedPane() {
        super();
        addMouseMotionListener(new MouseMotionAdapter() {
            // TODO

        });

        addMouseListener(new MouseAdapter() {
            public void mouseReleased(MouseEvent e) {
                int tabNumber = getUI().tabForCoordinate(DraggableTabbedPane.this, e.getX(), e.getY());
                if (dragging) {
                    if (tabNumber > 0 && tabNumber != draggedTabIndex && tabNumber != getTabCount() - 1) {
                        int indexWillPlace = draggedTabIndex;
                        if (toPlace.getType() == TabTypeEnum.TAB_MOVE_RIGHT) {
                            if (tabNumber > draggedTabIndex) {
                                indexWillPlace = tabNumber;
                            } else {
                                indexWillPlace = tabNumber + 1;
                            }
                        } else if (toPlace.getType() == TabTypeEnum.TAB_MOVE_LEFT) {
                            if (tabNumber > draggedTabIndex) {
                                indexWillPlace = tabNumber - 1;
                            } else {
                                indexWillPlace = tabNumber;
                            }
                        } else if (toPlace.getType() == TabTypeEnum.TAB_COMBINED) {
                            indexWillPlace = tabNumber;
                        }
                        if (indexWillPlace != draggedTabIndex) {
                            if (toPlace.getType() == TabTypeEnum.TAB_COMBINED) {
                                
                                ChatPane cp = Utils.getChatPane(draggedTabIndex);
                                if (cp != null) {
                                    ChatPane willPlace = Utils.getChatPane(indexWillPlace);
                                    if (willPlace != null) {
                                        
                                        
                                        CombinedChatPane combinedChatPane = CombinedChatPane.createCombinedChatPane(cp, willPlace);
                                        if (combinedChatPane != null) {
                                            if (!e.isControlDown()) {
                                                if (draggedTabIndex > indexWillPlace) {
                                                    removeTabAt(draggedTabIndex);
                                                    removeTabAt(indexWillPlace);
                                                } else {
                                                    removeTabAt(indexWillPlace);
                                                    removeTabAt(draggedTabIndex);
                                                }
                                            }
                                            insertTab(combinedChatPane.getTabTitle(), null, combinedChatPane.getScrollPane(), null, combinedChatPane.getIndex());
                                            setSelectedIndex(combinedChatPane.getIndex());
                                            GUIMain.combinedChatPanes.add(combinedChatPane);
                                        }
                                    } else {
                                        CombinedChatPane willPlaceCombined = Utils.getCombinedChatPane(indexWillPlace);
                                        if (willPlaceCombined != null) {
                                            
                                            

                                            if (willPlaceCombined.addChatPane(cp)) {
                                                
                                                removeTabAt(draggedTabIndex);
                                                setSelectedIndex(willPlaceCombined.getIndex());
                                            }
                                        }
                                    }
                                } else {
                                    CombinedChatPane ccp = Utils.getCombinedChatPane(draggedTabIndex);
                                    if (ccp != null) {
                                        ChatPane willPlace = Utils.getChatPane(indexWillPlace);
                                        if (willPlace != null) {
                                            
                                            
                                            if (ccp.addChatPane(willPlace)) {
                                                if (!e.isControlDown()) {
                                                    removeTabAt(indexWillPlace);
                                                }
                                                setSelectedIndex(ccp.getIndex());
                                            }
                                        } else {
                                            CombinedChatPane willPlaceCombined = Utils.getCombinedChatPane(indexWillPlace);
                                            if (willPlaceCombined != null) {
                                                
                                                if (ccp.addChatPane(willPlaceCombined.getPanes())) {
                                                    if (e.isControlDown()) {
                                                        removeTabAt(willPlaceCombined.getIndex());
                                                        
                                                        GUIMain.combinedChatPanes.remove(willPlaceCombined);
                                                    }
                                                    setSelectedIndex(ccp.getIndex());
                                                }
                                            }
                                        }
                                    }
                                }
                            } else { 
                                Component comp = getComponentAt(draggedTabIndex);
                                String title = getTitleAt(draggedTabIndex);
                                removeTabAt(draggedTabIndex);
                                insertTab(title, null, comp, null, indexWillPlace);
                                setSelectedIndex(indexWillPlace);
                            }
                        }
                    }
                }

                if (SwingUtilities.isRightMouseButton(e)) {
                    if (tabNumber > 0) {
                        ChatPane detected = Utils.getChatPane(tabNumber);
                        CombinedChatPane detectedCombo = Utils.getCombinedChatPane(tabNumber);
                        boolean first = (detected != null);
                        boolean second = (detectedCombo != null);
                        if (first || second) {
                            JPopupMenu popupMenu = new JPopupMenu();
                            PaneMenuListener listener = Constants.listenerPaneMenu;

                            JMenuItem menuItem = new JMenuItem("Pop-out chat");
                            menuItem.addActionListener(listener);
                            popupMenu.add(menuItem);

                            if (Settings.showTabPulses.getValue()) {
                                menuItem = new JMenuItem("Toggle Tab Pulsing " +
                                        (first ? (detected.shouldPulseLoc() ? "OFF" : "ON") :
                                                (detectedCombo.shouldPulseLoc() ? "OFF" : "ON")));
                                menuItem.addActionListener(listener);
                                popupMenu.add(menuItem);
                            }
                            if (first) {
                                menuItem = new JMenuItem("Go to " + detected.getChannel() + "'s channel");
                                menuItem.addActionListener(listener);
                                popupMenu.add(menuItem);

                                menuItem = new JMenuItem("View viewer list");
                                menuItem.addActionListener(listener);
                                popupMenu.add(menuItem);

                                menuItem = new JMenuItem("Remove tab");
                                menuItem.addActionListener(listener);
                                popupMenu.add(menuItem);
                            } else {
                                menuItem = new JMenuItem("Disband tab");
                                menuItem.addActionListener(listener);
                                popupMenu.add(menuItem);

                                menuItem = new JMenuItem("Rename tab");
                                menuItem.addActionListener(Constants.tabListener);
                                popupMenu.add(menuItem);

                                JMenu panels = new JMenu("Set Active Panel...");
                                JCheckBoxMenuItem streamCheck;
                                streamCheck = new JCheckBoxMenuItem("All");
                                streamCheck.addActionListener(listener);
                                if (detectedCombo.getActiveChannel().equalsIgnoreCase("All"))
                                    streamCheck.setState(true);
                                panels.add(streamCheck);

                                panels.add(new JPopupMenu.Separator());

                                String[] streams = detectedCombo.getChannels();
                                for (String stream : streams) {
                                    streamCheck = new JCheckBoxMenuItem(stream);
                                    streamCheck.addActionListener(listener);
                                    if (detectedCombo.getActiveChannel().equalsIgnoreCase(stream))
                                        streamCheck.setState(true);
                                    panels.add(streamCheck);
                                }
                                popupMenu.add(panels);
                            }

                            menuItem = new JMenuItem("Clear Chat");
                            menuItem.addActionListener(listener);
                            popupMenu.add(menuItem);

                            popupMenu.show((DraggableTabbedPane) e.getSource(), e.getX(), e.getY());
                        }
                    }
                }
                updateIndexes();
                tabImage = null;
                toPlace = null;
                dragging = false;
                repaint();
            }
        });
    }

    public void updateIndexes() {
        if (!GUIMain.chatPanes.isEmpty()) {
            for (int i = 0; i < getTabCount(); i++) {
                String title = getTitleAt(i);
                ChatPane toUpdate = GUIMain.chatPanes.get(title);
                if (toUpdate != null) toUpdate.setIndex(i);
            }
        }
        if (!GUIMain.combinedChatPanes.isEmpty()) {
            for (int i = 0; i < getTabCount(); i++) {
                String title = getTitleAt(i);
                for (CombinedChatPane cp : GUIMain.combinedChatPanes) {
                    if (cp.getTabTitle().equalsIgnoreCase(title)) {
                        cp.setIndex(i);
                        break;
                    }
                }
            }
        }
    }

    public void scrollDownPanes() {
        if (!GUIMain.chatPanes.isEmpty()) {
            ChatPane[] panes = GUIMain.chatPanes.values().toArray(new ChatPane[GUIMain.chatPanes.size()]);
            for (ChatPane p : panes) {
                p.scrollToBottom();
            }
        }
        if (!GUIMain.combinedChatPanes.isEmpty()) {
            GUIMain.combinedChatPanes.forEach(gui.CombinedChatPane::scrollToBottom);
        }
    }

    public AccessibleComponent getPage(int index) {
        try {
            Field pages = JTabbedPane.class.getDeclaredField("pages");
            pages.setAccessible(true);
            Object p = pages.get(this);
            return (AccessibleComponent) ((ArrayList) p).get(index);
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    @Override
    public void setTitleAt(int index, String title) {
        CombinedChatPane pane = Utils.getCombinedChatPane(index);
        if (pane != null && !pane.getTabTitle().equalsIgnoreCase(title)) pane.setCustomTitle(title);
        super.setTitleAt(index, title);
    }

    private final RenderingHints antialiasing = new RenderingHints(
            RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

    @Override
    protected void paintComponent(Graphics g) {
        super.paintComponent(g);
        Graphics2D g2 = (Graphics2D) g;
        g2.setRenderingHints(antialiasing);
        if (toPlace != null && toPlace.getType() != TabTypeEnum.TAB_NEITHER) {
            g2.setColor(Color.orange);
            Polygon toFill = getFillShape(toPlace);
            g2.fillPolygon(toFill);
            g2.drawRect((int) toPlace.getRectangle().getX(), (int) toPlace.getRectangle().getY(), (int) toPlace.getRectangle().getWidth(),
                    (int) toPlace.getRectangle().getHeight());
        }
        
        if (dragging && currentMouseLocation != null && tabImage != null) {
            
            g2.drawImage(tabImage, currentMouseLocation.x, currentMouseLocation.y, this);
        }
    }

    
    private Polygon getFillShape(TabType tabType) {
        Polygon p = new Polygon();
        Rectangle r = tabType.getRectangle();
        int centerRectX = (int) r.getCenterX();
        int centerRectY = (int) r.getCenterY();
        if (tabType.getType() == TabTypeEnum.TAB_MOVE_RIGHT) {
            int distX = (int) (r.getX() + r.getWidth()) - centerRectX;
            int distY = (int) (r.getY() + r.getHeight()) - centerRectY;
            Point first = new Point(centerRectX + (distX), centerRectY);
            p.addPoint(first.x, first.y);
            Point second;
            int x2 = (centerRectX - (distX / 2));
            int y2 = (centerRectY + (distY / 2));
            int y3 = (centerRectY - (distY / 2));
            second = new Point(x2, y2);
            p.addPoint(second.x, second.y);
            p.addPoint(second.x, y3);
        } else if (tabType.getType() == TabTypeEnum.TAB_MOVE_LEFT) {
            int distX = (int) (r.getX() + r.getWidth()) - centerRectX;
            int distY = (int) (r.getY() + r.getHeight()) - centerRectY;
            Point first = new Point((int) r.getX(), centerRectY);
            p.addPoint(first.x, first.y);
            Point second;
            int x2 = (centerRectX + distX);
            int y2 = (centerRectY + (distY / 2));
            int y3 = (centerRectY - (distY / 2));
            second = new Point(x2, y2);
            p.addPoint(second.x, second.y);
            p.addPoint(second.x, y3);
        } else {
            int distX = (int) (r.getX() + r.getWidth()) - centerRectX;
            int distY = (int) (r.getY() + r.getHeight()) - centerRectY;
            int outerX = (int) (distX / 1.25);
            int innerX = outerX / 2;
            int outerY = (int) (distY / 1.25);
            int innerY = outerY / 2;
            
            p.addPoint(centerRectX - innerX, centerRectY - innerY);
            p.addPoint(centerRectX - innerX, centerRectY - outerY);
            p.addPoint(centerRectX + innerX, centerRectY - outerY);
            p.addPoint(centerRectX + innerX, centerRectY - innerY);
            
            p.addPoint(centerRectX + outerX, centerRectY - innerY);
            p.addPoint(centerRectX + outerX, centerRectY + innerY);
            
            p.addPoint(centerRectX + innerX, centerRectY + innerY);
            p.addPoint(centerRectX + innerX, centerRectY + outerY);
            p.addPoint(centerRectX - innerX, centerRectY + outerY);
            p.addPoint(centerRectX - innerX, centerRectY + innerY);
            
            p.addPoint(centerRectX - outerX, centerRectY + innerY);
            p.addPoint(centerRectX - outerX, centerRectY - innerY);
        }
        return p;
    }

    
    @Override
    protected void fireStateChanged() {
        ChatPane cp = Utils.getChatPane(getSelectedIndex());
        CombinedChatPane ccp = Utils.getCombinedChatPane(getSelectedIndex());
        if (cp != null) GUIMain.updateTitle(cp.getViewerCountString());
        if (ccp != null) {
            String activeChan = ccp.getActiveChannel();
            GUIMain.updateTitle(activeChan.equalsIgnoreCase("all") ? null : GUIMain.chatPanes.get(activeChan).getViewerCountString());
        }
        if (getSelectedIndex() == getTabCount() - 1) return;
        super.fireStateChanged();
    }

    
    public TabType getTabType(MouseEvent e) {
        int tabNumber = getUI().tabForCoordinate(DraggableTabbedPane.this, e.getX(), e.getY());
        if (tabNumber == draggedTabIndex || tabNumber <= 0 || tabNumber == getTabCount() - 1)
            return new TabType(null, TabTypeEnum.TAB_NEITHER);
        Rectangle r = getUI().getTabBounds(DraggableTabbedPane.this, tabNumber);
        Rectangle leftHalf = new Rectangle((int) r.getX(), (int) r.getY(), (int) (r.getWidth() / 2), (int) r.getHeight());
        Rectangle leftMove = new Rectangle((int) leftHalf.getX(), (int) leftHalf.getY(), (int) (leftHalf.getWidth() / 2), (int) leftHalf.getHeight());
        Rectangle rightHalf = new Rectangle((int) (r.getX() + leftHalf.getWidth()), (int) r.getY(), (int) leftHalf.getWidth(), (int) leftHalf.getHeight()); 
        Rectangle rightMove = new Rectangle((int) (rightHalf.getX() + leftMove.getWidth()), (int) rightHalf.getY(), (int) (leftMove.getWidth()), (int) leftHalf.getHeight());
        Rectangle combine = new Rectangle((int) (r.getX() + leftMove.getWidth()), (int) r.getY(), (int) leftHalf.getWidth(), (int) r.getHeight());
        Point p = e.getPoint();
        if (leftMove.contains(p)) {
            return new TabType(leftMove, TabTypeEnum.TAB_MOVE_LEFT);
        } else if (rightMove.contains(p)) {
            return new TabType(rightMove, TabTypeEnum.TAB_MOVE_RIGHT);
        } else if (combine.contains(p)) {
            return new TabType(combine, TabTypeEnum.TAB_COMBINED);
        } else
            return new TabType(null, TabTypeEnum.TAB_NEITHER);
    }

    enum TabTypeEnum {
        TAB_COMBINED,
        TAB_MOVE_LEFT,
        TAB_MOVE_RIGHT,
        TAB_NEITHER
    }

    private class TabType {

        Rectangle rectangle;
        TabTypeEnum type;

        TabType(Rectangle r, TabTypeEnum type) {
            rectangle = r;
            this.type = type;
        }

        public Rectangle getRectangle() {
            return rectangle;
        }

        public TabTypeEnum getType() {
            return type;
        }
    }
}