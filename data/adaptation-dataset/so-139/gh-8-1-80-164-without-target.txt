package com.github.sommeri.less4j.utils;

import java.io.File;
import java.net.MalformedURLException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.regex.Pattern;

import org.apache.commons.io.FilenameUtils;

import com.github.sommeri.less4j.LessSource;
import com.github.sommeri.less4j.LessSource.FileSource;
import com.github.sommeri.less4j.platform.Constants;

public class URIUtils {

  public static final String URI_FILE_SEPARATOR = "/";

  public static URL toParentURL(URL url) {
    URL parentUrl;
    try {
        
        URL rootParentUrl = new URL(url, "");

        
        String query = url.getQuery();
        if (query == null || query.isEmpty()) {
            parentUrl = new URL(rootParentUrl.toString());
        } else {
            parentUrl = new URL(rootParentUrl.toString() + query);
        }
    } catch (MalformedURLException ex) {
        throw new RuntimeException(ex);
    }

    return parentUrl;
  }

  public static String relativize(File from, File to) {
    URI fromURI = from.toURI();
    URI toURI = to.toURI();

    String relative = getRelativePath(fromURI.toString(), toURI.toString(), URIUtils.URI_FILE_SEPARATOR);
    relative = convertUriToPlatformSeparator(relative);

    return relative;
  }

  public static String relativizeSourceURIs(LessSource from, LessSource to) {
    if (to == null)
      return null;

    URI toURI = to.getURI();
    if (toURI == null)
      return to.getName();

    String toURIAsString = toURI.toString();

    if (from == null)
      return toURIAsString;

    URI fromURI = from.getURI();
    if (fromURI == null)
      return toURIAsString;

    String fromURIAsString = fromURI.toString();

    return getRelativePath(fromURIAsString, toURIAsString, URIUtils.URI_FILE_SEPARATOR);
  }

  public static String convertUriToPlatformSeparator(String relative) {
    return relative.replace(URI_FILE_SEPARATOR, Constants.FILE_SEPARATOR);
  }

  public static String convertPlatformSeparatorToUri(String relative) {
    return relative.replace(Constants.FILE_SEPARATOR, URI_FILE_SEPARATOR);
  }

    // TODO


  public static String normalizeNoEndSeparator(String path, String separator) {
    String result = RelativeFilenameUtils.normalizeNoEndSeparator(path);

    
    if ("/".equals(separator)) {
      result = FilenameUtils.separatorsToUnix(result);

    } else if ("\\".equals(separator)) {
      result = FilenameUtils.separatorsToWindows(result);
    } else {
      throw new IllegalArgumentException("Unrecognised dir separator '" + separator + "'");
    }

    return result;
  }

  private static String safeSubstring(String string, int beginIndex) {
    if (beginIndex > string.length())
      return "";

    return string.substring(beginIndex);
  }

  public static String addPLatformSlashIfNeeded(String directory) {
    if (directory.endsWith(Constants.FILE_SEPARATOR))
      return directory;

    return directory + Constants.FILE_SEPARATOR;
  }

  public static URI changeSuffix(URI uri, String dottedSuffix) {
    if (uri==null)
      return null;
    
    URI newUri;

    try {

        String uriAsString = uri.toString();
        int lastIndexOfDot = uriAsString.lastIndexOf('.');
        if(lastIndexOfDot > -1) {
          newUri = new URI(uriAsString.substring(0, (lastIndexOfDot + 1)) + dottedSuffix);
      } else {
          newUri = new URI(uriAsString + dottedSuffix);
      }
    } catch (URISyntaxException exception) {
        throw new IllegalStateException(exception);
    }

    return newUri;
  }

  public static String changeSuffix(String filename, String dottedSuffix) {
    if (filename == null)
      return null;

    int lastIndexOf = filename.lastIndexOf('.');
    if (lastIndexOf == -1)
      return filename + dottedSuffix;

    return filename.substring(0, lastIndexOf) + dottedSuffix;
  }

  public static String addSuffix(String filename, String dottedSuffix) {
    if (filename == null)
      return null;

    return filename + dottedSuffix;
  }

  public static File changeSuffix(File file, String dottedSuffix) {
    if (file == null)
      return null;

    String filename = changeSuffix(file.toString(), dottedSuffix);
    return new File(filename);
  }

  public static FileSource changeSuffix(FileSource source, String dottedSuffix) {
    if (source == null)
      return null;

    return new LessSource.FileSource(changeSuffix(source.getInputFile(), dottedSuffix));
  }

  public static boolean isQuotedUrl(String url) {
    int length = url.length();
    if (length<2)
      return false;
    
    char first = url.charAt(0);
    char last = url.charAt(length-1);
    if (first!=last)
      return false;
    
    return first=='\'' || first=='"';
  }
}
