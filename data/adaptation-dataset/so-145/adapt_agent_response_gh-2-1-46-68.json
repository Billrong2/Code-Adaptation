{
  "code": "private NoteBlockClickableSpan getSpanUnderTouch(final TextView textView, final Spannable spannable, final MotionEvent event) {\n    if (textView == null || spannable == null || event == null) {\n        return null;\n    }\n\n    final Layout layout = textView.getLayout();\n    if (layout == null) {\n        return null;\n    }\n\n    final int x = (int) event.getX() - textView.getTotalPaddingLeft() + textView.getScrollX();\n    final int y = (int) event.getY() - textView.getTotalPaddingTop() + textView.getScrollY();\n\n    if (x < 0 || y < 0) {\n        return null;\n    }\n\n    final int line = layout.getLineForVertical(y);\n    if (line < 0 || line >= layout.getLineCount()) {\n        return null;\n    }\n\n    final int offset = layout.getOffsetForHorizontal(line, x);\n    if (offset < 0 || offset >= spannable.length()) {\n        return null;\n    }\n\n    final NoteBlockClickableSpan[] spans = spannable.getSpans(offset, offset, NoteBlockClickableSpan.class);\n    if (spans == null || spans.length == 0) {\n        return null;\n    }\n\n    return spans[0];\n}",
  "explanation": "code_hardening: Added null checks for TextView, Spannable, MotionEvent, and Layout; validated x/y coordinates, line index, and character offset bounds; used final for parameters and locals to reduce accidental mutation.\nresolve_compilation_errors: Removed any dependency on mPressedSpan, Selection, and super.onTouchEvent; replaced TouchableSpan usage with NoteBlockClickableSpan; introduced a self-contained helper method with a clear signature that compiles independently.\nexception_handling: none.\nlogic_customization: Implemented detection-only logic that computes touch coordinates relative to text content by adjusting for padding and scroll, maps y to a line and x to an offset via TextView.getLayout(), and queries the Spannable for NoteBlockClickableSpan at that offset, returning the first match or null.\nrefactoring: Renamed and reshaped the logic into a single-responsibility helper (getSpanUnderTouch) with simplified, linear control flow and no stateful side effects.\nmisc: Updated behavior to reflect detection-only responsibility; no new custom API calls were introduced beyond existing Android framework methods (e.g., android.text.Layout methods)."
}