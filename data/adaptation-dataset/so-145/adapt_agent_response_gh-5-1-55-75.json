{
  "code": "private CustomClickableSpan getPressedSpan(final TextView textView, final Spannable spannable, final MotionEvent event) {\n    if (textView == null || spannable == null || event == null) {\n        return null;\n    }\n\n    final android.text.Layout layout = textView.getLayout();\n    if (layout == null) {\n        return null;\n    }\n\n    // Adjust touch coordinates to text content coordinates\n    int x = (int) event.getX();\n    int y = (int) event.getY();\n\n    x -= textView.getTotalPaddingLeft();\n    y -= textView.getTotalPaddingTop();\n\n    x += textView.getScrollX();\n    y += textView.getScrollY();\n\n    if (x < 0 || y < 0) {\n        return null;\n    }\n\n    final int line = layout.getLineForVertical(y);\n    if (line < 0 || line >= layout.getLineCount()) {\n        return null;\n    }\n\n    final int offset = layout.getOffsetForHorizontal(line, x);\n    if (offset < 0 || offset > spannable.length()) {\n        return null;\n    }\n\n    final CustomClickableSpan[] spans = spannable.getSpans(offset, offset, CustomClickableSpan.class);\n    if (spans != null && spans.length > 0) {\n        return spans[0];\n    }\n\n    return null;\n}",
  "explanation": "code_hardening: Added null checks for TextView, Spannable, MotionEvent, and Layout; validated adjusted coordinates, line index, and character offset before querying spans; marked parameters as final to prevent reassignment.\nresolve_compilation_errors: Implemented the missing helper method with a signature compatible with existing onTouchEvent calls; removed any dependency on pressed-state fields, Selection, or super calls by keeping this method purely span-detection focused; relied only on existing project types such as cn.iwgang.simplifyspan.customspan.CustomClickableSpan and android.text.Layout.\nexception_handling: none.\nlogic_customization: Replaced touch-state logic with a helper that computes touch coordinates in text space by adjusting for total padding and scroll offsets, uses Layout.getLineForVertical and Layout.getOffsetForHorizontal to find the character offset, and returns the first CustomClickableSpan at that offset or null if none.\nrefactoring: Encapsulated all span hit-testing logic into a clearly scoped helper method, simplifying responsibilities and removing any state management from this logic.\nmisc: Updated inline comments to clarify coordinate adjustment and intent; formatting simplified for readability; no new custom API calls beyond existing Android and project classes (none)."
}