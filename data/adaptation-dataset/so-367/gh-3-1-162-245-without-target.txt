package com.tweetlanes.android.core.widget;

import android.content.Context;
import android.text.Layout.Alignment;
import android.text.StaticLayout;
import android.text.TextPaint;
import android.util.AttributeSet;
import android.util.TypedValue;
import android.widget.TextView;


public class AutoResizeTextView extends TextView {

    
    private static final float MIN_TEXT_SIZE = 20;

    
    public interface OnTextResizeListener {

        public void onTextResize(TextView textView, float oldSize, float newSize);
    }

    
    private static final String mEllipsis = "...";

    
    private OnTextResizeListener mTextResizeListener;

    
    private boolean mNeedsResize = false;

    
    
    private float mTextSize;

    
    private float mMaxTextSize = 0;

    
    private float mMinTextSize = MIN_TEXT_SIZE;

    
    private float mSpacingMult = 1.0f;

    
    private float mSpacingAdd = 0.0f;

    
    private boolean mAddEllipsis = true;

    
    public AutoResizeTextView(Context context) {
        this(context, null);
    }

    
    public AutoResizeTextView(Context context, AttributeSet attrs) {
        this(context, attrs, 0);
    }

    
    public AutoResizeTextView(Context context, AttributeSet attrs, int defStyle) {
        super(context, attrs, defStyle);
        mTextSize = getTextSize();
    }

    
    @Override
    protected void onTextChanged(final CharSequence text, final int start,
                                 final int before, final int after) {
        mNeedsResize = true;
        
        resetTextSize();
    }

    
    @Override
    protected void onSizeChanged(int w, int h, int oldw, int oldh) {
        if (w != oldw || h != oldh) {
            mNeedsResize = true;
        }
    }

    
    public void setOnResizeListener(OnTextResizeListener listener) {
        mTextResizeListener = listener;
    }

    
    @Override
    public void setTextSize(float size) {
        super.setTextSize(size);
        mTextSize = getTextSize();
    }

    
    @Override
    public void setTextSize(int unit, float size) {
        super.setTextSize(unit, size);
        mTextSize = getTextSize();
    }

    
    @Override
    public void setLineSpacing(float add, float mult) {
        super.setLineSpacing(add, mult);
        mSpacingMult = mult;
        mSpacingAdd = add;
    }

    
    void resetTextSize() {
        if (mTextSize > 0) {
            super.setTextSize(TypedValue.COMPLEX_UNIT_PX, mTextSize);
            mMaxTextSize = mTextSize;
        }
    }

    
    @Override
    protected void onLayout(boolean changed, int left, int top, int right,
                            int bottom) {
        if (changed || mNeedsResize) {
            int widthLimit = (right - left) - getCompoundPaddingLeft()
                    - getCompoundPaddingRight();
            int heightLimit = (bottom - top) - getCompoundPaddingBottom()
                    - getCompoundPaddingTop();
            resizeText(widthLimit, heightLimit);
        }
        super.onLayout(changed, left, top, right, bottom);
    }

        // TODO


    
    
    private int getTextHeight(CharSequence source, TextPaint paint, int width,
                              float textSize) {
        
        paint.setTextSize(textSize);
        
        StaticLayout layout = new StaticLayout(source, paint, width,
                Alignment.ALIGN_NORMAL, mSpacingMult, mSpacingAdd, true);
        return layout.getHeight();
    }

}