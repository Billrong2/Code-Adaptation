{
"code":"public static String reshape_browser(String Str) {\n        if (Str == null || Str.length() == 0) {\n            return \"\";\n        }\n        String Temp = \" \" + Str + \"   \"; // pad for safe lookahead\n        StringBuilder reshapedString = new StringBuilder(Str.length());\n        int len = Str.length();\n        int i = 0;\n\n        char pre, at, post, post_post;\n        char pre_pre = ' ';\n        boolean pre_can_connect = false;\n\n        while (i < len) {\n            pre = Temp.charAt(i);\n            at = Temp.charAt(i + 1);\n            post = Temp.charAt(i + 2);\n\n            // Normalize Arabic comma (U+060C) to ASCII comma\n            if (at == '\\u060C') {\n                reshapedString.append(',');\n                pre_can_connect = false;\n                i++;\n                continue;\n            }\n\n            int which_case = getCase(at);\n            int what_case_post = getCase(post);\n            int what_case_pre = getCase(pre);\n            int what_case_post_post;\n\n            int pre_step = 0;\n            if (what_case_pre == TASHKEEL) {\n                pre = pre_pre;\n                what_case_pre = getCase(pre);\n            }\n            if ((what_case_pre & LEFT_CHAR_MASK) == LEFT_CHAR_MASK && pre_can_connect) {\n                pre_step = 1;\n            }\n\n            switch (which_case & 0x000F) {\n                case NOTUSED_CHAR:\n                case NOTARABIC_CHAR:\n                    reshapedString.append(at);\n                    pre_can_connect = false;\n                    i++;\n                    continue;\n\n                case NORIGHT_NOLEFT_CHAR:\n                    reshapedString.append(getShape(at, 0));\n                    pre_can_connect = false;\n                    i++;\n                    continue;\n\n                case TATWEEL_CHAR:\n                    reshapedString.append(getShape(at, 0));\n                    pre_can_connect = false; // Tatweel explicitly breaks connectivity\n                    i++;\n                    continue;\n\n                case RIGHT_LEFT_CHAR_LAM:\n                    if ((what_case_post & 0x000F) == RIGHT_NOLEFT_CHAR_ALEF) {\n                        reshapedString.append(getShape(post, pre_step + 2));\n                        pre_can_connect = false; // lam–alef ligature ends join\n                        i += 2;\n                        continue;\n                    } else if ((what_case_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                        reshapedString.append(getShape(at, 2 + pre_step));\n                        pre_can_connect = true;\n                        i++;\n                        continue;\n                    } else if (what_case_post == TANWEEN) {\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i++;\n                        continue;\n                    } else if (what_case_post == TASHKEEL) {\n                        if (i + 3 < Temp.length()) {\n                            post_post = Temp.charAt(i + 3);\n                            what_case_post_post = getCase(post_post);\n                            if ((what_case_post_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                                reshapedString.append(getShape(at, 2 + pre_step));\n                                pre_can_connect = true;\n                                i++;\n                                continue;\n                            }\n                        }\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i++;\n                        continue;\n                    } else {\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i++;\n                        continue;\n                    }\n\n                case RIGHT_LEFT_CHAR:\n                    if ((what_case_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                        reshapedString.append(getShape(at, 2 + pre_step));\n                        pre_can_connect = true;\n                        i++;\n                        continue;\n                    } else if (what_case_post == TANWEEN) {\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i++;\n                        continue;\n                    } else if (what_case_post == TASHKEEL) {\n                        if (i + 3 < Temp.length()) {\n                            post_post = Temp.charAt(i + 3);\n                            what_case_post_post = getCase(post_post);\n                            if ((what_case_post_post & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                                reshapedString.append(getShape(at, 2 + pre_step));\n                                pre_can_connect = true;\n                                i++;\n                                continue;\n                            }\n                        }\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i++;\n                        continue;\n                    } else {\n                        reshapedString.append(getShape(at, pre_step));\n                        pre_can_connect = false;\n                        i++;\n                        continue;\n                    }\n\n                case RIGHT_NOLEFT_CHAR_ALEF:\n                case RIGHT_NOLEFT_CHAR:\n                    reshapedString.append(getShape(at, pre_step));\n                    pre_can_connect = false;\n                    i++;\n                    continue;\n\n                case TASHKEEL:\n                    reshapedString.append(getShape(at, 0));\n                    pre_pre = pre;\n                    // connectivity unchanged\n                    i++;\n                    continue;\n\n                case TANWEEN:\n                    reshapedString.append(getShape(at, 0));\n                    pre_pre = pre;\n                    pre_can_connect = false;\n                    i++;\n                    continue;\n\n                default:\n                    reshapedString.append(getShape(at, 0));\n                    pre_can_connect = false;\n                    i++;\n            }\n        }\n        return reshapedString.toString();\n    }",
"explanation":"code_hardening: Added null/empty input handling, padded the temporary string to make lookahead safe, added explicit bounds checks before accessing i+3, normalized Arabic comma early, and ensured pre_can_connect is reset in all branches that break connectivity.\nresolve_compilation_errors: Renamed the method to reshape_browser, declared and initialized the pre_can_connect boolean, and relied only on existing project constants and direct callees (getCase, getShape) so the function compiles in the target class.\nexception_handling: none.\nlogic_customization: Implemented Arabic comma (U+060C) normalization to ASCII ',', introduced and maintained the pre_can_connect state, explicitly reset it after non-Arabic/unused characters, Tatweel, and lam–alef ligature handling, separated NORIGHT_NOLEFT_CHAR and TATWEEL_CHAR cases so Tatweel breaks connectivity, and adjusted lam lookahead when followed by Tashkeel to inspect the correct subsequent character while updating connectivity consistently.\nrefactoring: Renamed the method as requested, slightly restructured switch cases to isolate Tatweel handling, and grouped connectivity updates next to shaping decisions for clarity without changing shaping outputs.\nmisc: none."
}