{
  "code": "public static String reshape(String input) {\n    if (input == null || input.isEmpty()) {\n        return \"\";\n    }\n\n    final int CASE_MASK = 0x000F;\n\n    final String padded = \" \" + input + \" \";\n    final int length = input.length();\n    final StringBuilder result = new StringBuilder(length);\n\n    int index = 0;\n    char previousPrevious = ' ';\n\n    while (index < length) {\n        final int base = index;\n\n        final char previous = padded.charAt(base);\n        final char current = padded.charAt(base + 1);\n        final char next = (base + 2 < padded.length()) ? padded.charAt(base + 2) : ' ';\n\n        int currentCase = getCase(current);\n        int nextCase = getCase(next);\n        int previousCase = getCase(previous);\n\n        int preStep = 0;\n        char effectivePrevious = previous;\n\n        if (previousCase == TASHKEEL) {\n            effectivePrevious = previousPrevious;\n            previousCase = getCase(effectivePrevious);\n        }\n\n        if ((previousCase & LEFT_CHAR_MASK) == LEFT_CHAR_MASK) {\n            preStep = 1;\n        }\n\n        switch (currentCase & CASE_MASK) {\n            case NOTUSED_CHAR:\n            case NOTARABIC_CHAR:\n                result.append(current);\n                index++;\n                continue;\n\n            case NORIGHT_NOLEFT_CHAR:\n            case TATWEEL_CHAR:\n                result.append(getShape(current, 0));\n                index++;\n                continue;\n\n            case RIGHT_LEFT_CHAR_LAM:\n                if ((nextCase & CASE_MASK) == RIGHT_NOLEFT_CHAR_ALEF) {\n                    result.append(getShape(next, preStep + 2));\n                    index += 2;\n                    continue;\n                } else if ((nextCase & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                    result.append(getShape(current, 2 + preStep));\n                    index++;\n                    continue;\n                } else if (nextCase == TANWEEN) {\n                    result.append(getShape(current, preStep));\n                    index++;\n                    continue;\n                } else if (nextCase == TASHKEEL) {\n                    final char nextNext = (base + 3 < padded.length()) ? padded.charAt(base + 3) : ' ';\n                    final int nextNextCase = getCase(nextNext);\n\n                    if ((nextNextCase & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                        result.append(getShape(current, 2 + preStep));\n                        index++;\n                        continue;\n                    } else {\n                        result.append(getShape(current, preStep));\n                        index++;\n                        continue;\n                    }\n                } else {\n                    result.append(getShape(current, preStep));\n                    index++;\n                    continue;\n                }\n\n            case RIGHT_LEFT_CHAR:\n                if ((nextCase & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                    result.append(getShape(current, 2 + preStep));\n                    index++;\n                    continue;\n                } else if (nextCase == TANWEEN) {\n                    result.append(getShape(current, preStep));\n                    index++;\n                    continue;\n                } else if (nextCase == TASHKEEL) {\n                    final char nextNext = (base + 3 < padded.length()) ? padded.charAt(base + 3) : ' ';\n                    final int nextNextCase = getCase(nextNext);\n\n                    if ((nextNextCase & RIGHT_NOLEFT_CHAR_MASK) == RIGHT_NOLEFT_CHAR_MASK) {\n                        result.append(getShape(current, 2 + preStep));\n                        index++;\n                        continue;\n                    } else {\n                        result.append(getShape(current, preStep));\n                        index++;\n                        continue;\n                    }\n                } else {\n                    result.append(getShape(current, preStep));\n                    index++;\n                    continue;\n                }\n\n            case RIGHT_NOLEFT_CHAR_ALEF:\n            case RIGHT_NOLEFT_CHAR:\n                result.append(getShape(current, preStep));\n                index++;\n                continue;\n\n            case TASHKEEL:\n            case TANWEEN:\n                result.append(getShape(current, 0));\n                index++;\n                previousPrevious = effectivePrevious;\n                continue;\n\n            default:\n                result.append(getShape(current, 0));\n                index++;\n        }\n    }\n\n    return result.toString();\n}",
  "explanation": "code_hardening: Added null and empty-string handling, guarded all charAt accesses with bounds checks for i+2 and i+3, and marked local variables final where they are not reassigned.\nresolve_compilation_errors: Aligned the function with the existing ArabicReshape class by using existing constants and the getCase(char) and getShape(char,int) methods; introduced a local CASE_MASK constant to replace the literal mask safely.\nexception_handling: none\nlogic_customization: none\nrefactoring: Renamed parameters and local variables to descriptive names (input, padded, index, current, next, result), replaced the magic mask literal with a named constant, and normalized control-flow structure without changing behavior.\nmisc: Applied consistent indentation, spacing, and switch-case formatting to match the surrounding code style and removed commented-out debug artifacts; no new custom API calls were introduced."
}