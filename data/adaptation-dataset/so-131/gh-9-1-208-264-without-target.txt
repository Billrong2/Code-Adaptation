package com.calsignlabs.apde.contrib;

import android.os.Handler;
import android.os.Message;

import com.calsignlabs.apde.APDE;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.Properties;
import java.util.zip.ZipEntry;
import java.util.zip.ZipFile;
import java.util.zip.ZipInputStream;


public class ContributionManager {
	
	public static final int LIBRARY_UPDATE = 22885;
	
	
	public static boolean installDirLibrary(Library library, File libraryDir, Handler handler, APDE context) {
		library.setStatus(Library.Status.COPYING);
		handler.sendMessage(Message.obtain(handler, LIBRARY_UPDATE, library.getStatus()));
		
		
		if (!copyFile(libraryDir, library.getLibraryFolder(context))) {
			System.err.println("Unexcepted error occurred while copying the library.");
			return false;
		}
		
		library.setStatus(Library.Status.DEXING);
		handler.sendMessage(Message.obtain(handler, LIBRARY_UPDATE, library.getStatus()));
		
		
		
		
		library.getLibraryJarDexFolder(context).mkdir();
		
		try {
			File[] jars = library.getLibraryJars(context);
			File[] dexJars = library.getLibraryDexJars(context);
			
			
			for(int i = 0; i < jars.length; i ++) {
				dexJar(jars[i], dexJars[i]);
			}
		} catch (NullPointerException e) {
			
			System.err.println("Unable to locate the library JAR files at " + library.getLibraryJarFolder(context));
			System.err.println("Try organizing the folder structure according the Processing library formatting guidelines.");
			e.printStackTrace();
			return false;
		}
		
		library.setStatus(Library.Status.INSTALLED);
		handler.sendMessage(Message.obtain(handler, LIBRARY_UPDATE, library.getStatus()));
		
		return false;
	}
	
	
	public static boolean installZipLibrary(Library library, File libraryZip, Handler handler, APDE context) {
		library.setStatus(Library.Status.EXTRACTING);
		handler.sendMessage(Message.obtain(handler, LIBRARY_UPDATE, library.getStatus()));
		
		
		if(!extractFile(libraryZip, library.getLibraryFolder(context))) {
			System.err.println("Unexcepted error occurred while extracting the library.");
			return false;
		}
		
		library.setStatus(Library.Status.DEXING);
		handler.sendMessage(Message.obtain(handler, LIBRARY_UPDATE, library.getStatus()));
		
		
		
		
		library.getLibraryJarDexFolder(context).mkdir();
		
		try {
			File[] jars = library.getLibraryJars(context);
			File[] dexJars = library.getLibraryDexJars(context);
			
			
			for(int i = 0; i < jars.length; i ++) {
				dexJar(jars[i], dexJars[i]);
			}
		} catch (NullPointerException e) {
			
			System.err.println("Unable to locate the library JAR files at " + library.getLibraryJarFolder(context));
			System.err.println("Try organizing the folder structure within the ZIP file according the Processing library formatting guidelines.");
			e.printStackTrace();
			return false;
		}
		
		library.setStatus(Library.Status.INSTALLED);
		handler.sendMessage(Message.obtain(handler, LIBRARY_UPDATE, library.getStatus()));
		
		return true;
	}
	
	
	public static String detectLibraryName(File libraryZip) {
		
		
		ZipInputStream zis = null;
		
		try {
			String filename;
			zis = new ZipInputStream(new BufferedInputStream(new FileInputStream(libraryZip)));
			ZipEntry ze;
			
			
			String backupName = "";
			
			while((ze = zis.getNextEntry()) != null) {
				filename = ze.getName();
				
				if(isJunkFilename(filename)) {
					zis.closeEntry();
					
					continue;
				}
				
				
				if(backupName.equals("") && ze.isDirectory()) {
					
					backupName = filename.substring(0, filename.length() - 1);
				}
				
				
				int lastSlash = filename.lastIndexOf("/");
				
				
				if((lastSlash >= 0 ? filename.substring(lastSlash, filename.length()) : filename).equals(Library.propertiesFilename)) {
					ZipFile zipFile = new ZipFile(libraryZip);
					
					
					Properties props = new Properties();
					props.load(zipFile.getInputStream(ze));
					
					
					String libraryName = props.getProperty("name");
					
					zipFile.close();
					
					
					if(libraryName != null) {
						return libraryName;
					}
				}
				
				zis.closeEntry();
			}
			
			
			
			if(!backupName.equals("")) {
				
				return backupName;
			}
			
			zis.close();
		} catch(IOException e) {
			e.printStackTrace();
		} finally {
			try {
				if (zis != null) {
					zis.close();
				}
			} catch (IOException e) {
				
				e.printStackTrace();
			}
		}
		
		
		String zipName = libraryZip.getName();
		
		
		if(zipName.endsWith(".zip")) {
			zipName = zipName.substring(0, zipName.length() - 4);
		}
		
		return zipName;
	}
	
		// TODO

	
	private static boolean copyFile(File input, File output) {
		try {
			APDE.copyFile(input, output);
		} catch (Exception e) {
			e.printStackTrace();
			
			return false;
		}
		
		return true;
	}
	
	private static boolean isJunkFilename(String zipFilename) {
		
		
		
		
		
		
		String[] files = zipFilename.split("/");
		
		for(String file : files) {
			
			if(file.startsWith("_") || file.startsWith(".")) {
				return true;
			}
		}
			
		return false;
	}
	
	
	public static void dexJar(File input, File output) {
		try {
			String[] args = new String[] {
					"--output=" + output.getAbsolutePath(), 
					input.getAbsolutePath(), 
			};
			
			
			
			com.android.dx.command.dexer.Main.Arguments dexArgs = new com.android.dx.command.dexer.Main.Arguments();
			dexArgs.parse(args);
			
			int resultCode = com.android.dx.command.dexer.Main.run(dexArgs);
			
			if (resultCode != 0) {
				System.err.println("DX Dexer failed, error code: " + resultCode);
			}
		} catch (Exception e) {
			System.err.println("DX Dexer failed");
			e.printStackTrace();
		}
	}
	
	
	public static void uninstallLibrary(Library library, APDE context) {
		deleteFile(library.getLibraryFolder(context));
	}
	
	
	public static void deleteFile(File f) {
		if(f.isDirectory())
			for(File c : f.listFiles())
				deleteFile(c);
		
		
		
		final File to = new File(f.getAbsolutePath() + System.currentTimeMillis());
		f.renameTo(to);
		
		if(!to.delete())
			System.err.println("Failed to delete file: " + f);
	}
}