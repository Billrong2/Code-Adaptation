package magic.data.json;

import java.io.File;
import java.io.IOException;
import magic.data.GeneralConfig;
import magic.utility.MagicFileSystem;
import magic.utility.MagicFileSystem.DataPath;
import magic.utility.MagicSystem;
import org.json.JSONObject;

public final class NewVersionJsonParser {
    private NewVersionJsonParser() {}

    public static String getLatestVersion() {
        final File jsonFile = MagicFileSystem.getDataPath(DataPath.LOGS).resolve("newversion.json").toFile();
        if (downloadJsonToFile(jsonFile)) {
            return getVersionInJsonFile(jsonFile);
        } else {
            return "";
        }
    }

    private static boolean downloadJsonToFile(final File jsonFile) {
        try {
            final DownloadableJsonFile downloadFile = new DownloadableJsonFile("https://magarena.github.io/current.json", jsonFile);
            downloadFile.doDownload(GeneralConfig.getInstance().getProxy());
            if (jsonFile.length() == 0) {
                System.err.println("new version json file is empty!");
                return false;
            } else {
                return true;
            }
        } catch (IOException ex) {
            System.err.println("Error accessing/saving new version json feed:- " + ex);
            return false;
        }
    }

    
    private static String getVersionInJsonFile(final File jsonFile ) {
        try {
            final JSONObject jsonRelease = new JSONObject(DownloadableJsonFile.getJsonString(jsonFile));
            final String release = jsonRelease.getString("version");
            return isNewVersion(release) ? release : "";
        } catch (IOException ex) {
            System.err.println(ex);
        }
        return "";
    }

    private static boolean isNewVersion(final String releaseValue) {
        return releaseValue != null && versionCompare(releaseValue, MagicSystem.VERSION) > 0;
    }

        // TODO

}
