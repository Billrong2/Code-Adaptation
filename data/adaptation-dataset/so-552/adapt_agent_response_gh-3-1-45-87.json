{
  "code": "@Override\nprotected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {\n    final int widthMode = android.view.View.MeasureSpec.getMode(widthMeasureSpec);\n    final int heightMode = android.view.View.MeasureSpec.getMode(heightMeasureSpec);\n\n    // Resolve available width after padding\n    int availableWidth = android.view.View.MeasureSpec.getSize(widthMeasureSpec)\n            - getPaddingLeft() - getPaddingRight();\n    if (availableWidth < 0) {\n        availableWidth = 0;\n    }\n\n    final int count = getChildCount();\n\n    int xPos = getPaddingLeft();\n    int yPos = getPaddingTop();\n\n    int currentLineHeight = 0;\n    int maxWidthUsed = 0;\n\n    // Children always measure their height as UNSPECIFIED (natural height)\n    final int childWidthMeasureSpec = android.view.View.MeasureSpec.makeMeasureSpec(\n            availableWidth, android.view.View.MeasureSpec.AT_MOST);\n    final int childHeightMeasureSpec = android.view.View.MeasureSpec.makeMeasureSpec(\n            0, android.view.View.MeasureSpec.UNSPECIFIED);\n\n    for (int i = 0; i < count; i++) {\n        final android.view.View child = getChildAt(i);\n        if (child == null || child.getVisibility() == GONE) {\n            continue;\n        }\n\n        final android.view.ViewGroup.LayoutParams rawLp = child.getLayoutParams();\n        if (!(rawLp instanceof LayoutParams)) {\n            continue;\n        }\n        final LayoutParams lp = (LayoutParams) rawLp;\n\n        final int hSpacing = Math.max(0, lp.horizontal_spacing);\n        final int vSpacing = Math.max(0, lp.vertical_spacing);\n\n        child.measure(childWidthMeasureSpec, childHeightMeasureSpec);\n\n        final int childWidth = child.getMeasuredWidth();\n        final int childHeight = child.getMeasuredHeight();\n\n        // Line break if needed\n        if (xPos + childWidth > getPaddingLeft() + availableWidth) {\n            yPos += currentLineHeight;\n            xPos = getPaddingLeft();\n            currentLineHeight = 0;\n        }\n\n        xPos += childWidth + hSpacing;\n        maxWidthUsed = Math.max(maxWidthUsed, xPos);\n\n        // Track max height for the current line\n        currentLineHeight = Math.max(currentLineHeight, childHeight + vSpacing);\n    }\n\n    // Advance by the last line's height\n    yPos += currentLineHeight;\n\n    // Store final computed line height for onLayout\n    this.line_height = currentLineHeight;\n\n    int measuredWidth;\n    if (widthMode == android.view.View.MeasureSpec.EXACTLY) {\n        measuredWidth = android.view.View.MeasureSpec.getSize(widthMeasureSpec);\n    } else {\n        measuredWidth = maxWidthUsed + getPaddingRight();\n        if (widthMode == android.view.View.MeasureSpec.AT_MOST) {\n            measuredWidth = Math.min(measuredWidth, android.view.View.MeasureSpec.getSize(widthMeasureSpec));\n        }\n    }\n\n    int measuredHeight;\n    if (heightMode == android.view.View.MeasureSpec.EXACTLY) {\n        measuredHeight = android.view.View.MeasureSpec.getSize(heightMeasureSpec);\n    } else {\n        measuredHeight = yPos + getPaddingBottom();\n        if (heightMode == android.view.View.MeasureSpec.AT_MOST) {\n            measuredHeight = Math.min(measuredHeight, android.view.View.MeasureSpec.getSize(heightMeasureSpec));\n        }\n    }\n\n    setMeasuredDimension(measuredWidth, measuredHeight);\n}",
  "explanation": "code_hardening: Added null checks for child views and their LayoutParams, guarded against invalid LayoutParams types, ensured horizontal and vertical spacing are non-negative, and protected against negative available width after padding subtraction.\nresolve_compilation_errors: Used the existing class-level field line_height to store the computed line height, relied on the existing PredicateLayout.LayoutParams with horizontal_spacing and vertical_spacing, and referenced MeasureSpec and View using fully qualified names to avoid import issues.\nexception_handling: none.\nlogic_customization: Measured all children with UNSPECIFIED height to allow natural sizing, removed dependence on the parent height mode for child measurement, tracked the current line height as the maximum child height plus vertical spacing per line, reset and recomputed this value on line breaks, advanced the y-position using the computed max line height, and stored the final computed line height into the class-level line_height field. Overall height resolution behavior for UNSPECIFIED and AT_MOST modes was preserved.\nrefactoring: Renamed local variables for clarity (xPos, yPos, currentLineHeight), introduced intermediate variables for MeasureSpec modes and spacing values, and simplified repeated calculations for readability.\nmisc: Updated inline comments to reflect the new measurement behavior (UNSPECIFIED child height and max line height logic) and reformatted the method for consistent style."
}