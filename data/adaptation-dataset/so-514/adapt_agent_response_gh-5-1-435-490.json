{
  "code": "private void setUpNestedScreen(final PreferenceScreen preferenceScreen) {\n    if (preferenceScreen == null) {\n        return;\n    }\n\n    final Dialog dialog = preferenceScreen.getDialog();\n    if (dialog == null) {\n        return;\n    }\n\n    // Ensure dialog-aware cancel handling instead of finishing the activity\n    dialog.setOnCancelListener(new DialogInterface.OnCancelListener() {\n        @Override\n        public void onCancel(DialogInterface dialogInterface) {\n            if (AppData.getLoginSuccessful()) {\n                dialogInterface.dismiss();\n            } else {\n                showNotConnectedDialog(dialog);\n            }\n        }\n    });\n\n    Toolbar toolbar = null;\n\n    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.ICE_CREAM_SANDWICH) {\n        // ICS+ uses a simpler parent traversal inside the dialog\n        final View listView = dialog.findViewById(android.R.id.list);\n        if (listView != null) {\n            View parent = listView.getParent();\n            if (parent instanceof ViewGroup) {\n                final ViewGroup root = (ViewGroup) parent;\n                toolbar = (Toolbar) LayoutInflater.from(this)\n                        .inflate(R.layout.settings_toolbar, root, false);\n                root.addView(toolbar, 0); // insert at top\n            }\n        }\n    } else {\n        // Pre-ICS: re-parent content and apply top padding inside dialog hierarchy\n        final View contentRoot = dialog.findViewById(android.R.id.content);\n        if (contentRoot instanceof ViewGroup) {\n            final ViewGroup root = (ViewGroup) contentRoot;\n            if (root.getChildCount() > 0 && root.getChildAt(0) instanceof ListView) {\n                final ListView content = (ListView) root.getChildAt(0);\n                root.removeAllViews();\n\n                toolbar = (Toolbar) LayoutInflater.from(this)\n                        .inflate(R.layout.settings_toolbar, root, false);\n\n                int height;\n                final TypedValue tv = new TypedValue();\n                if (getTheme().resolveAttribute(R.attr.actionBarSize, tv, true)) {\n                    height = TypedValue.complexToDimensionPixelSize(tv.data, getResources().getDisplayMetrics());\n                } else {\n                    height = toolbar.getLayoutParams() != null ? toolbar.getLayoutParams().height : 0;\n                }\n\n                content.setPadding(0, height, 0, 0);\n                root.addView(content);\n                root.addView(toolbar, 0);\n            }\n        }\n    }\n\n    if (toolbar == null) {\n        return;\n    }\n\n    // Set toolbar title from the PreferenceScreen\n    if (preferenceScreen.getTitle() != null) {\n        toolbar.setTitle(preferenceScreen.getTitle());\n    }\n\n    // Navigation behaves like dialog-aware back\n    toolbar.setNavigationOnClickListener(new View.OnClickListener() {\n        @Override\n        public void onClick(View v) {\n            if (AppData.getLoginSuccessful()) {\n                dialog.dismiss();\n            } else {\n                showNotConnectedDialog(dialog);\n            }\n        }\n    });\n}",
  "explanation": "code_hardening: Added null checks for PreferenceScreen, Dialog, view lookups, and guarded parent traversal with instanceof checks. Provided a safe fallback for toolbar height calculation when theme resolution fails.\nresolve_compilation_errors: Replaced activity-based lifecycle usage with a custom setup method for nested PreferenceScreens, switched all view lookups to dialog.findViewById, and replaced finish() with dialog.dismiss(). Uses existing project APIs and types only.\nexception_handling: none.\nlogic_customization: Shifted toolbar setup to operate on nested PreferenceScreen dialogs, lowered API split to ICE_CREAM_SANDWICH, inserted the toolbar at the top of the dialog hierarchy, set the toolbar title from PreferenceScreen.getTitle(), and implemented dialog-aware navigation/cancel behavior based on AppData.getLoginSuccessful(), invoking showNotConnectedDialog(Dialog) when required.\nrefactoring: Renamed local variables for clarity (bar â†’ toolbar), localized all toolbar setup logic within this method, and simplified parent traversal for ICS+.\nmisc: Updated inline comments to reflect dialog-based behavior and kept formatting consistent with the existing project style. New custom API usage: picframe.at.picframe.settings.AppData#getLoginSuccessful() and existing showNotConnectedDialog(Dialog)."}