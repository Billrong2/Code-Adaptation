package de.uni_potsdam.hpi.openmensa.api.preferences;

import android.content.Context;
import android.content.SharedPreferences;
import android.os.Build;
import android.preference.PreferenceManager;
import android.util.Log;

import com.google.gson.Gson;

import java.util.HashSet;
import java.util.Set;
import java.util.ArrayList;
import org.json.JSONArray;
import org.json.JSONException;

import de.uni_potsdam.hpi.openmensa.MainActivity;
import de.uni_potsdam.hpi.openmensa.R;


public class SettingsUtils {

	public static final String KEY_SOURCE_URL = "pref_source_url";
	public static final String KEY_STORAGE = "om_storage";
	
	
	public static final String KEY_FAVOURITES = "pref_favourites";

    public static final String KEY_STYLE = "pref_style";

	private static Gson gson = new Gson();
	
    
    private static SharedPreferences getSharedPrefs(Context context) {
    	return PreferenceManager.getDefaultSharedPreferences(context);
    }
    
    public static String getSourceUrl(Context context) {
    	return getSharedPrefs(context).getString(KEY_SOURCE_URL, context.getResources().getString(R.string.source_url_default));

    }
    
    public static Storage getStorage(Context context) {
    	
    	String json = getSharedPrefs(context).getString(KEY_STORAGE, "{}");
    	return gson.fromJson(json, Storage.class);
    }
    
    public static void setStorage(Context context, Storage storage) {
    	String json = gson.toJson(storage);
    	
    	SharedPreferences.Editor editor = getSharedPrefs(context).edit();
    	editor.putString(SettingsUtils.KEY_STORAGE, json);
    	editor.commit();
    }
    public static int getThemeByString(String theme) {
        if (theme.equalsIgnoreCase("dark")) {
            return com.actionbarsherlock.R.style.Theme_Sherlock;
        } else if (theme.equalsIgnoreCase("light")) {
            return com.actionbarsherlock.R.style.Theme_Sherlock_Light;
        } else {
            Log.w(MainActivity.TAG, "Theme not found");
            return com.actionbarsherlock.R.style.Theme_Sherlock;
        }
    }

    
	public static void updateFavouriteCanteensFromPreferences(Context context) {
        Set<String> favouriteCanteenKeys;
        if (android.os.Build.VERSION.SDK_INT >= Build.VERSION_CODES.HONEYCOMB) {
            favouriteCanteenKeys = getSharedPrefs(context).getStringSet(KEY_FAVOURITES, new HashSet<String>());
        } else {
            favouriteCanteenKeys = new HashSet(getStringArrayPref(context, KEY_FAVOURITES));
        }
		Log.d(MainActivity.TAG, String.format("Got favourites %s", favouriteCanteenKeys));
		Storage storage = getStorage(context);
		storage.setFavouriteCanteens(favouriteCanteenKeys);
		storage.saveToPreferences(context);
	}

        // TODO

}
