


package net.usikkert.kouchat.ui.swing;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.Frame;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;

import javax.swing.AbstractAction;
import javax.swing.Action;
import javax.swing.BorderFactory;
import javax.swing.JButton;
import javax.swing.JComponent;
import javax.swing.JDialog;
import javax.swing.JEditorPane;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.KeyStroke;
import javax.swing.UIManager;
import javax.swing.WindowConstants;
import javax.swing.event.HyperlinkEvent;
import javax.swing.event.HyperlinkListener;

import net.usikkert.kouchat.misc.ErrorHandler;
import net.usikkert.kouchat.settings.Settings;
import net.usikkert.kouchat.ui.swing.messages.SwingMessages;
import net.usikkert.kouchat.util.Validate;


public class MessageDialog extends JDialog {

    private final JLabel appNameL;
    private final EditorWithHtmlSupport contentEditor;

    
    public MessageDialog(final ImageLoader imageLoader,
                         final SwingMessages swingMessages,
                         final Settings settings,
                         final ErrorHandler errorHandler) {
        super((Frame) null, true);

        Validate.notNull(imageLoader, "Image loader can not be null");
        Validate.notNull(swingMessages, "Swing messages can not be null");
        Validate.notNull(settings, "Settings can not be null");
        Validate.notNull(errorHandler, "Error handler can not be null");

        final UITools uiTools = new UITools();

        setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);
        setTitle(uiTools.createTitle("Missing title")); 
        setResizable(false);

        final StatusIcons statusIcons = new StatusIcons(imageLoader);
        setIconImage(statusIcons.getNormalIcon());

        appNameL = new JLabel();
        appNameL.setFont(new Font("Dialog", 0, 22));
        appNameL.setIcon(statusIcons.getNormalIconImage());
        appNameL.setText("No top text"); 

        final JPanel northP = new JPanel();
        northP.setBackground(Color.WHITE);
        northP.setBorder(BorderFactory.createMatteBorder(0, 0, 1, 0, Color.BLACK));
        northP.setLayout(new FlowLayout(FlowLayout.LEFT, 12, 12));
        northP.add(appNameL);

        getContentPane().add(northP, BorderLayout.PAGE_START);

        final JButton okB = new JButton();
        okB.setText(swingMessages.getMessage("swing.button.ok"));
        okB.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(final ActionEvent e) {
                dispose();
            }
        });

        getRootPane().setDefaultButton(okB);

        final JPanel southP = new JPanel();
        southP.setLayout(new FlowLayout(FlowLayout.CENTER, 12, 12));
        southP.add(okB);

        getContentPane().add(southP, BorderLayout.PAGE_END);

        final JLabel iconIconL = new JLabel();
        iconIconL.setIcon(UIManager.getIcon("OptionPane.informationIcon"));

        final JPanel leftP = new JPanel();
        leftP.setLayout(new FlowLayout(FlowLayout.CENTER, 12, 12));
        leftP.add(iconIconL);

        getContentPane().add(leftP, BorderLayout.LINE_START);

        contentEditor = new EditorWithHtmlSupport(uiTools, settings, errorHandler, swingMessages);

        final JPanel centerP = new JPanel();
        centerP.setBorder(BorderFactory.createEmptyBorder(12, 2, 0, 12));
        centerP.setLayout(new BorderLayout());
        centerP.add(contentEditor, BorderLayout.CENTER);

        getContentPane().add(centerP, BorderLayout.CENTER);

        
        final KeyStroke escapeKeyStroke = KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0, false);

        final Action escapeAction = new AbstractAction() {
            @Override
            public void actionPerformed(final ActionEvent e) {
                dispose();
            }
        };

        getRootPane().getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW).put(escapeKeyStroke, "ESCAPE");
        getRootPane().getActionMap().put("ESCAPE", escapeAction);
    }

    
    public void setTopText(final String text) {
        appNameL.setText(" " + text);
    }

    
    public void setContent(final String info) {
        contentEditor.setText(info);
    }

    
    @Override
    public void setVisible(final boolean visible) {
        pack();
        setLocationRelativeTo(getParent());
        super.setVisible(visible);
    }

    
    private static class EditorWithHtmlSupport extends JEditorPane {

        private final StringBuffer style;

        EditorWithHtmlSupport(final UITools uiTools,
                              final Settings settings,
                              final ErrorHandler errorHandler,
                              final SwingMessages swingMessages) {
            super("text/html", "");

            style = createStyle();

            setEditable(false);
            setBorder(null);

            addHyperlinkListener(new HyperlinkListener() {
                @Override
                public void hyperlinkUpdate(final HyperlinkEvent event) {
                    if (event.getEventType().equals(HyperlinkEvent.EventType.ACTIVATED)) {
                        uiTools.browse(event.getURL().toString(), settings, errorHandler, swingMessages);
                    }
                }
            });
        }

        @Override
        public void setText(final String htmlBody) {
            super.setText("<html><body style=\"" + style + "\">" + htmlBody + "</body></html>");
        }

        // TODO

}
