

package be.uclouvain.multipathcontrol.stats;

import java.lang.reflect.Method;

import android.telephony.PhoneStateListener;
import android.telephony.ServiceState;
import android.telephony.SignalStrength;
import android.telephony.TelephonyManager;

public class PhoneState {

	private static final int SIGNAL_STRENGTH_NONE_OR_UNKNOWN = 0;

	private static final int SIGNAL_STRENGTH_POOR = 1;
	private static final int SIGNAL_STRENGTH_MODERATE = 2;
	private static final int SIGNAL_STRENGTH_GOOD = 3;
	private static final int SIGNAL_STRENGTH_GREAT = 4;

	private static final int GSM_SIGNAL_STRENGTH_GREAT = 12;
	private static final int GSM_SIGNAL_STRENGTH_GOOD = 8;
	private static final int GSM_SIGNAL_STRENGTH_MODERATE = 8; 

	private TelephonyManager telephonyManager;

	private int lastSignalStrength;
	private int lastSignalStrengthDbm;
	private int lastBer;

	private static PhoneState instance = null;

	public static PhoneState getInstance(TelephonyManager telephonyManager) {
		if (instance == null)
			instance = new PhoneState(telephonyManager);
		return instance;
	}

	private PhoneState(TelephonyManager telephonyManager) {
		this.telephonyManager = telephonyManager;
		telephonyManager.listen(phoneStateListener,
				PhoneStateListener.LISTEN_SIGNAL_STRENGTHS
						| PhoneStateListener.LISTEN_SERVICE_STATE);
	}

	public int getLastSignalStrength() {
		return lastSignalStrength;
	}

	public int getLastSignalStrengthDbm() {
		return lastSignalStrengthDbm;
	}

	public int getLastBer() {
		return lastBer;
	}

		// TODO


	public String getSimState() {
		int simState = telephonyManager.getSimState();
		switch (simState) {
		case TelephonyManager.SIM_STATE_ABSENT:
			return "Absent";
		case TelephonyManager.SIM_STATE_NETWORK_LOCKED:
			return "NetworkLocked";
		case TelephonyManager.SIM_STATE_PIN_REQUIRED:
			return "PinRequired";
		case TelephonyManager.SIM_STATE_PUK_REQUIRED:
			return "PukRequired";
		case TelephonyManager.SIM_STATE_READY:
			return "Ready";
		case TelephonyManager.SIM_STATE_UNKNOWN:
			return "Unknown";
		}
		return "Error";
	}

	public String getDataState() {
		int dataState = telephonyManager.getDataState();
		switch (dataState) {
		case TelephonyManager.DATA_CONNECTED:
			return "Connected";
		case TelephonyManager.DATA_CONNECTING:
			return "Connecting";
		case TelephonyManager.DATA_DISCONNECTED:
			return "Disconnected";
		case TelephonyManager.DATA_SUSPENDED:
			return "Suspended";
		}
		return "Error";
	}

	public String getDataActivity() {
		int dataActivity = telephonyManager.getDataActivity();
		switch (dataActivity) {
		case TelephonyManager.DATA_ACTIVITY_DORMANT:
			return "Dormant";
		case TelephonyManager.DATA_ACTIVITY_IN:
			return "In";
		case TelephonyManager.DATA_ACTIVITY_INOUT:
			return "InOut";
		case TelephonyManager.DATA_ACTIVITY_NONE:
			return "None";
		case TelephonyManager.DATA_ACTIVITY_OUT:
			return "Out";
		}
		return "Error";
	}

	
	private static int getLevel(SignalStrength signalStrength) {
		if (signalStrength.isGsm())
			return getGSMSignalStrength(signalStrength);
		return 0;
	}

	
	private static int getDbm(TelephonyManager telephonyManager,
			SignalStrength signalStrength) {
		if (!signalStrength.isGsm())
			return 0;

		if (getLteLevel(telephonyManager, signalStrength) == SIGNAL_STRENGTH_NONE_OR_UNKNOWN)
			return getGsmDbm(signalStrength);
		else
			return getLteDbm(signalStrength);
	}

	
	private static int getGSMSignalStrength(SignalStrength signalStrength) {
		
		
		
		
		int asu = signalStrength.getGsmSignalStrength();
		if (asu <= 2 || asu == 99)
			return SIGNAL_STRENGTH_NONE_OR_UNKNOWN;
		else if (asu >= GSM_SIGNAL_STRENGTH_GREAT)
			return SIGNAL_STRENGTH_GREAT;
		else if (asu >= GSM_SIGNAL_STRENGTH_GOOD)
			return SIGNAL_STRENGTH_GOOD;
		else if (asu >= GSM_SIGNAL_STRENGTH_MODERATE)
			return SIGNAL_STRENGTH_MODERATE;
		else
			return SIGNAL_STRENGTH_POOR;
	}

	
	private static int getGsmDbm(SignalStrength signalStrength) {
		int dBm;

		int level = signalStrength.getGsmSignalStrength();
		int asu = level == 99 ? SIGNAL_STRENGTH_NONE_OR_UNKNOWN : level;
		if (asu != SIGNAL_STRENGTH_NONE_OR_UNKNOWN) {
			dBm = -113 + 2 * asu;
		} else {
			dBm = SIGNAL_STRENGTH_NONE_OR_UNKNOWN;
		}
		return dBm;
	}

	
	private static int getLteLevel(TelephonyManager telephonyManager,
			SignalStrength signalStrength) {
		
		
		
		
		
		
		

		if (telephonyManager.getNetworkType() != TelephonyManager.NETWORK_TYPE_LTE) {
			return SIGNAL_STRENGTH_NONE_OR_UNKNOWN;
		}
		try {
			Method methodGetLteLevel = SignalStrength.class
					.getMethod("getLteLevel");
			return (Integer) methodGetLteLevel.invoke(signalStrength);
		} catch (Throwable t) {
			return SIGNAL_STRENGTH_NONE_OR_UNKNOWN;
		}
	}

	
	private static int getLteDbm(SignalStrength signalStrength) {
		
		
		
		
		try {
			Method methodGetLteDbm = SignalStrength.class
					.getMethod("getLteDbm");
			return (Integer) methodGetLteDbm.invoke(signalStrength);
		} catch (Throwable t) {
			return SIGNAL_STRENGTH_NONE_OR_UNKNOWN;
		}
	}

	private final PhoneStateListener phoneStateListener = new PhoneStateListener() {
		@Override
		public void onSignalStrengthsChanged(SignalStrength signalStrength) {
			lastSignalStrength = getLevel(signalStrength);
			lastSignalStrengthDbm = getDbm(telephonyManager, signalStrength);
			lastBer = signalStrength.getGsmBitErrorRate();
		}

		@Override
		public void onServiceStateChanged(ServiceState serviceState) {
			if (serviceState.getState() != ServiceState.STATE_IN_SERVICE) {
				lastSignalStrength = SIGNAL_STRENGTH_NONE_OR_UNKNOWN;
				lastSignalStrengthDbm = SIGNAL_STRENGTH_NONE_OR_UNKNOWN;
				lastBer = 0;
			}
		}
	};
}
