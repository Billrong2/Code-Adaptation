package me.hyunbin.transit;

import android.content.Context;
import android.support.v4.view.MotionEventCompat;
import android.support.v4.widget.SwipeRefreshLayout;
import android.util.AttributeSet;
import android.view.MotionEvent;

import com.crashlytics.android.Crashlytics;



public class BetterSwipeRefreshLayout extends SwipeRefreshLayout {

    private int mActivePointerId;

    public BetterSwipeRefreshLayout(Context context) {
        super(context);
    }

    public BetterSwipeRefreshLayout(Context context, AttributeSet attrs) {
        super(context, attrs);
    }

    // TODO


    @Override
    public boolean onTouchEvent(MotionEvent ev) {
        if(ev.getAction() == MotionEvent.ACTION_CANCEL) {
            int pointerCount = MotionEventCompat.getPointerCount(ev);
            int index = MotionEventCompat.getActionIndex(ev);
            mActivePointerId = MotionEventCompat.getPointerId(ev, index);
            index = MotionEventCompat.findPointerIndex(ev,mActivePointerId);
            if (index > -1 && index < pointerCount) {
                try{
                    super.onTouchEvent(ev);
                } catch (Exception e){
                    
                    
                    Crashlytics.logException(e);
                    return true;
                }
            } else {
                return true;
            }
        }else if(ev.getAction() == MotionEventCompat.ACTION_POINTER_DOWN && super.onTouchEvent(ev)) {
            final int index = MotionEventCompat.getActionIndex(ev);
            mActivePointerId = MotionEventCompat.getPointerId(ev, index);
            return false;
        }else if(ev.getAction() == MotionEventCompat.ACTION_POINTER_UP && super.onTouchEvent(ev)){
            onSecondaryPointerUp(ev);
            return false;
        }else if(ev.getAction() == MotionEvent.ACTION_DOWN && super.onTouchEvent(ev)){
            mActivePointerId = MotionEventCompat.getPointerId(ev, 0);
            return false;
        }
        return super.onTouchEvent(ev);
    }

    private void onSecondaryPointerUp(MotionEvent ev) {
        final int pointerIndex = MotionEventCompat.getActionIndex(ev);
        final int pointerId = MotionEventCompat.getPointerId(ev, pointerIndex);
        if (pointerId == mActivePointerId) {
            final int newPointerIndex = pointerIndex == 0 ? 1 : 0;
            mActivePointerId = MotionEventCompat.getPointerId(ev, newPointerIndex);
        }
    }
}
