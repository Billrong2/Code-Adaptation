



package com.r3pwn.LetMeMakeYouSomeSandwiches;

import android.content.Context;
import android.content.SharedPreferences;
import android.database.sqlite.SQLiteDatabase;
import android.widget.Toast;
import android.widget.ToggleButton;

import eu.chainfire.libsuperuser.Shell;

import java.io.*;

import android.util.*;
import android.widget.*;
import android.os.*;
import android.app.*;
import android.view.View.*;
import android.view.*;
import android.content.pm.*;

class UpdateDatabase implements ToggleButton.OnCheckedChangeListener, View.OnClickListener {
    private ToggleButton toggleButton;
    private Button button;
    private String database_name;
    private String database_value = "";
    private String editor_name;
    private String app_name;
    private MainActivity mainActivity;
    private CustomDebug customDebug;
    private ProgressDialog writeProgress;
    private Boolean override = false;
    private Boolean isChecked = true;
    private Button readySetGo = null;
    private SharedPreferences.Editor editor;

    UpdateDatabase(MainActivity mainActivity, ToggleButton toggleButton, Boolean isChecked, String database_name, String editor_name, String app_name, PackageManager pm) {
        this.toggleButton = toggleButton;
        this.isChecked = isChecked;
        this.database_name = database_name;
        this.editor_name = editor_name;
        this.app_name = app_name;
        this.mainActivity = mainActivity;

        try {
            pm.getPackageInfo(app_name, PackageManager.GET_ACTIVITIES);
        } catch (PackageManager.NameNotFoundException e) {
            toggleButton.setEnabled(false);
        }
    }

    UpdateDatabase(CustomDebug customDebug, Button button, String entry_name, String entry_value, String app_name, Boolean override, Button readySetGo) {
        this.button = button;
        this.database_name = entry_name;
        this.database_value = entry_value;
        this.app_name = app_name;
        this.customDebug = customDebug;
        this.override = override;
        this.readySetGo = readySetGo;
    }

    @Override
    public void onCheckedChanged(CompoundButton cb, boolean checked) {
        
        new BackgroundDatabaseInjector().execute();
    }

    @Override
    public void onClick(View p1) {
        new BackgroundDatabaseInjector().execute();
        
        readySetGo.setEnabled(true);
        button.setEnabled(false);
    }

    // TODO


    private class BackgroundDatabaseInjector extends AsyncTask<String, Void, String> {

        
        @Override
        protected String doInBackground(String... params) {
            
            if (!override) {
                editor = mainActivity.defaultSharedPreferences.edit();
            }

            
            File databasesDir = new File("/data/data/com.r3pwn.LetMeMakeYouSomeSandwiches/databases");
            File gservicesDb = new File("/data/data/com.r3pwn.LetMeMakeYouSomeSandwiches/databases/gservices.db");
            File gservicesWorkingDb = new File("/data/data/com.r3pwn.LetMeMakeYouSomeSandwiches/databases/gservices_working.db");

            if (!databasesDir.exists()) {
                databasesDir.mkdir();
            } else {
                
                Shell.SU.run("rm -f " + databasesDir + "/*\n");
            }

            
            Shell.SU.run("cp /data/data/com.google.android.gsf/databases/gservices.db " + gservicesDb + "\n");
            Shell.SU.run("restorecon " + gservicesDb);
            Shell.SU.run("chmod 0777 " + gservicesDb);

            
            while (!isCompletelyWritten(gservicesDb)) {
                try {
                    Thread.sleep(15);
                } catch (InterruptedException e) {
                    if (!override) {
                        Toast.makeText(mainActivity.getApplicationContext(), "Database writing interrupted!", Toast.LENGTH_SHORT).show();
                    } else {
                        Toast.makeText(customDebug.getApplicationContext(), "Database writing interrupted!", Toast.LENGTH_SHORT).show();
                    }
                }
            }

            
            gservicesDb.renameTo(gservicesWorkingDb);

            while (!isCompletelyWritten(gservicesWorkingDb)) { 
                try {
                    Thread.sleep(5);
                } catch (InterruptedException e) {
                    if (!override) {
                        Toast.makeText(mainActivity.getApplicationContext(), "Database writing interrupted!", Toast.LENGTH_SHORT).show();
                    } else {
                        Toast.makeText(customDebug.getApplicationContext(), "Database writing interrupted!", Toast.LENGTH_SHORT).show();
                    }
                }
            }

            
            SQLiteDatabase db;
            if (!override) {
                db = mainActivity.openOrCreateDatabase(gservicesWorkingDb.toString(), Context.MODE_WORLD_READABLE, null);
            } else {
                db = customDebug.openOrCreateDatabase(gservicesWorkingDb.toString(), Context.MODE_WORLD_READABLE, null);
            }

            
            if (!override) {
                if (isChecked) {
                    
                    try {
                        db.execSQL("INSERT INTO overrides (name, value) VALUES ('" + database_name + "', 'true');");
                    } catch (android.database.SQLException sqle) {
                        
                        
                        db.execSQL("UPDATE overrides SET value='true' WHERE name='" + database_name + "';");
                    }
                    editor.putInt(editor_name, 1);
                    editor.commit();
                } else {
                    
                    db.execSQL("DELETE FROM overrides WHERE name='" + database_name + "';");
                    editor.putInt(editor_name, 0);
                    editor.commit();
                }
            } else {
                try {
                    db.execSQL("INSERT INTO overrides (name, value) VALUES ('" + database_name + "', '" + database_value + "');");
                } catch (android.database.SQLException sqle) {
                    
                    
                    db.execSQL("UPDATE overrides SET value='" + database_value + "' WHERE name='" + database_name + "';");
                }
            }
            
            db.close();

            
            Shell.SU.run("mv  /data/data/com.google.android.gsf/databases/gservices.db /data/data/com.google.android.gsf/databases/gservices.db.old\n");
            Shell.SU.run("rm  /data/data/com.google.android.gsf/databases/gservices.db-journal\n");
            Shell.SU.run("cp " + gservicesWorkingDb + " /data/data/com.google.android.gsf/databases/gservices.db\n");
            Shell.SU.run("restorecon /data/data/com.google.android.gsf/databases/gservices.db\n");
            Shell.SU.run("chmod 0777 /data/data/com.google.android.gsf/databases/gservices.db\n");

            
            Shell.SU.run("am force-stop com.google.android.gsf\n");
            if (!app_name.equals("")) {
                Shell.SU.run("am force-stop " + app_name + "\n");
            }

            
            Shell.SU.run("rm -f /data/data/com.r3pwn.LetMeMakeYouSomeSandwiches/databases/*\n");

            return "Done";
        }

        @Override
        protected void onPostExecute(String result) {
            if (!override) {
                Toast.makeText(mainActivity.getApplicationContext(), "Changes applied.", Toast.LENGTH_SHORT).show();
            } else {
                Toast.makeText(customDebug.getApplicationContext(), "Changes applied.", Toast.LENGTH_SHORT).show();
            }
            writeProgress.cancel();
        }

        @Override
        protected void onPreExecute() {
            if (!override) {
                writeProgress = new ProgressDialog(mainActivity);
            } else {
                writeProgress = new ProgressDialog(customDebug);
            }
            writeProgress.setCancelable(false);
            writeProgress.setMessage("Writing to database...");
            writeProgress.setProgressStyle(ProgressDialog.STYLE_SPINNER);
            writeProgress.show();
        }

        @Override
        protected void onProgressUpdate(Void... values) {
        }
    }
}
